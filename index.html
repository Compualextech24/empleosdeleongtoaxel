<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Portal de Vacantes - Empleos León GTO">
    <meta name="theme-color" content="#667eea">
    <title>Empleos León GTO - Portal de Vacantes</title>

    <link rel="icon" type="image/png" sizes="32x32" href="faviconempleos.png">
    <link rel="apple-touch-icon" sizes="180x180" href="faviconempleos.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
/* ==================== VARIABLES DE COLOR ==================== */
:root {
    --purple-1: #7c3aed;
    --purple-2: #6d28d9;
    --purple-3: #5b21b6;
    --purple-soft: #8b5cf6;
    --purple-light: #a78bfa;
    --purple-xlight: #c4b5fd;
    --purple-bg: rgba(109, 40, 217, 0.22);
    --purple-dark-1: #1e1b4b;
    --purple-dark-2: #312e81;
    --purple-dark-3: #4c1d95;
    --indigo-1: #667eea;
    --indigo-2: #764ba2;
    --green-1: #22c55e;
    --green-2: #16a34a;
    --green-3: #10b981;
    --green-4: #059669;
    --red-1: #dc2626;
    --red-2: #b91c1c;
    --red-3: #991b1b;
    --red-bg: rgba(220, 38, 38, 0.15);
    --blue-1: #3b82f6;
    --blue-2: #2563eb;
    --blue-3: #1d4ed8;
    --blue-4: #1e40af;
    --orange-1: #f59e0b;
    --orange-2: #d97706;
    --orange-3: #b45309;
    --gold: #FFD700;
    --gold-dim: rgba(255, 215, 0, 0.3);
    --gray-100: #f9fafb;
    --gray-200: #e5e7eb;
    --gray-300: #d1d5db;
    --gray-400: #9ca3af;
    --gray-500: #6b7280;
    --gray-600: #4b5563;
    --gray-700: #374151;
    --gray-800: #1f2937;
    --gray-900: #111827;
    --white-10: rgba(255, 255, 255, 0.10);
    --white-18: rgba(255, 255, 255, 0.18);
    --white-22: rgba(255, 255, 255, 0.22);
    --white-32: rgba(255, 255, 255, 0.32);
    --white-40: rgba(255, 255, 255, 0.40);
    --white-45: rgba(255, 255, 255, 0.45);
    --grad-purple: linear-gradient(135deg, var(--purple-1) 0%, var(--purple-2) 100%);
    --grad-purple-header: linear-gradient(135deg, var(--purple-1) 0%, var(--purple-2) 60%, var(--purple-3) 100%);
    --grad-indigo: linear-gradient(135deg, var(--indigo-1) 0%, var(--indigo-2) 100%);
    --grad-green: linear-gradient(135deg, var(--green-1) 0%, var(--green-2) 100%);
    --grad-green-save: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
    --grad-red: linear-gradient(135deg, var(--red-1) 0%, var(--red-2) 100%);
    --grad-blue: linear-gradient(135deg, var(--blue-1) 0%, var(--blue-2) 100%);
    --grad-blue-deep: linear-gradient(135deg, var(--blue-2) 0%, var(--blue-3) 100%);
    --grad-orange: linear-gradient(135deg, var(--orange-1) 0%, var(--orange-2) 100%);
    --grad-dark: linear-gradient(135deg, #1f2937 0%, #0f172a 100%);
}

/* ==================== RESET Y BASE ==================== */
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: var(--grad-indigo);
    min-height: 100vh;
    overflow-x: hidden;
    color: #1a1a1a;
}

/* ==================== ANIMACIONES ==================== */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to   { opacity: 1; transform: translateY(0); }
}
@keyframes slideIn {
    from { transform: translateX(-100%); }
    to   { transform: translateX(0); }
}
@keyframes spin {
    0%   { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
@keyframes slideUp {
    from { opacity: 0; transform: translateX(-50%) translateY(50px) scale(0.9); }
    to   { opacity: 1; transform: translateX(-50%) translateY(0) scale(1); }
}
@keyframes pulse {
    0%, 100% { opacity: 1; }
    50%       { opacity: 0.6; }
}
@keyframes modalPop {
    from { transform: scale(0.95); opacity: 0; }
    to   { transform: scale(1); opacity: 1; }
}
@keyframes pointingHand {
    0%, 100% { transform: translateX(0); }
    50%       { transform: translateX(5px); }
}
@keyframes shimmerLight {
    0%   { left: -100%; opacity: 0; }
    10%  { opacity: 1; }
    60%  { left: 160%; opacity: 1; }
    65%  { opacity: 0; }
    100% { left: 160%; opacity: 0; }
}
@keyframes guestGlow {
    0%, 100% { text-shadow: 0 0 10px rgba(34,197,94,0.6), 0 0 20px rgba(34,197,94,0.4); }
    50%       { text-shadow: 0 0 20px rgba(34,197,94,0.8), 0 0 30px rgba(34,197,94,0.6); }
}
@keyframes marqueeScroll {
    0%   { transform: translateX(100%); }
    100% { transform: translateX(-100%); }
}
@keyframes cardShimmer {
    0%   { left: -100%; opacity: 0; }
    10%  { opacity: 1; }
    60%  { left: 160%; opacity: 1; }
    65%  { opacity: 0; }
    100% { left: 160%; opacity: 0; }
}

.fade-in { animation: fadeIn 0.5s ease-out forwards; }
.slide-in { animation: slideIn 0.3s ease-out forwards; }

/* ==================== BOTONES — BASE ==================== */
.btn {
    padding: 10px 24px;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    border: none;
    font-size: 14px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}
.btn:disabled { opacity: 0.5; cursor: not-allowed; }

.btn-primary { background: var(--indigo-1); color: white; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
.btn-primary:hover:not(:disabled) { background: #5568d3; }

.btn-secondary { background: var(--gray-200); color: var(--gray-700); box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
.btn-secondary:hover:not(:disabled) { background: var(--gray-300); }

.btn-outline, .btn-edit {
    background: var(--grad-blue);
    color: white;
    box-shadow: 0 4px 14px rgba(59,130,246,0.4);
    border: none;
}
.btn-outline:hover:not(:disabled), .btn-edit:hover:not(:disabled) {
    background: var(--grad-blue-deep);
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(59,130,246,0.45);
}

.btn-save, .btn-new-vacancy {
    background: var(--grad-green-save);
    color: white;
    box-shadow: 0 4px 14px rgba(34,197,94,0.4);
    font-weight: 700;
}
.btn-save:hover:not(:disabled), .btn-new-vacancy:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(34,197,94,0.5);
}

.btn-new-vacancy {
    padding: 10px 16px;
    border-radius: 12px;
    font-size: 14px;
    height: 42px;
    white-space: nowrap;
    gap: 6px;
}
.btn-nueva-text { display: none; }
@media (min-width: 640px) { .btn-nueva-text { display: inline; } }

.btn-clean {
    background: var(--grad-orange);
    color: white;
    box-shadow: 0 4px 14px rgba(245,158,11,0.35);
}
.btn-clean:hover:not(:disabled) {
    background: linear-gradient(135deg, var(--orange-2) 0%, var(--orange-3) 100%);
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(245,158,11,0.45);
}

.btn-autofill {
    background: linear-gradient(135deg, var(--purple-soft) 0%, var(--purple-1) 100%);
    color: white;
    box-shadow: 0 4px 14px rgba(139,92,246,0.4);
}
.btn-autofill:hover:not(:disabled) { background: var(--grad-purple); transform: translateY(-2px); }

.btn-calendar {
    background: var(--grad-indigo);
    color: white;
    box-shadow: 0 4px 14px rgba(102,126,234,0.4);
    font-weight: 700;
    padding: 10px 20px;
    border-radius: 12px;
}
.btn-calendar:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(102,126,234,0.5); }

.btn-cancel {
    background: var(--red-bg);
    color: var(--red-1);
    border: 1.5px solid rgba(220, 38, 38, 0.35);
    font-weight: 700;
    backdrop-filter: blur(4px);
}
.btn-cancel:hover:not(:disabled) {
    background: rgba(220, 38, 38, 0.28);
    border-color: rgba(220, 38, 38, 0.6);
    transform: translateY(-2px);
    box-shadow: 0 6px 18px rgba(220, 38, 38, 0.25);
}

.btn-compact {
    padding: 10px 16px;
    min-width: auto;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    border-radius: 12px;
    font-weight: 600;
    transition: all 0.3s ease;
}

.btn-calendar-active {
    background: var(--grad-orange) !important;
    box-shadow: 0 4px 14px rgba(245,158,11,0.5) !important;
    animation: pulse 2s infinite;
}

.btn-whatsapp-card {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    width: 100%;
    margin-top: 12px;
    padding: 12px 20px;
    background: linear-gradient(135deg, #25d366 0%, #80e8a8 100%);
    color: #ffffff;
    font-size: 0.9rem;
    font-weight: 700;
    text-decoration: none;
    border-radius: 12px;
    box-shadow: 0 4px 14px rgba(37, 211, 102, 0.35);
    transition: transform 0.2s ease, box-shadow 0.2s ease, filter 0.2s ease;
    letter-spacing: 0.01em;
    will-change: transform;
}
.btn-whatsapp-card i { font-size: 1.1rem; }
.btn-whatsapp-card:hover { transform: translateY(-2px); box-shadow: 0 8px 22px rgba(37, 211, 102, 0.45); filter: brightness(1.05); }
.btn-whatsapp-card:active { transform: translateY(0); box-shadow: 0 3px 10px rgba(37, 211, 102, 0.3); }

.btn-see-all {
    background: var(--white-18);
    color: white;
    border: 2px solid var(--white-40);
    border-radius: 14px;
    padding: 14px 32px;
    font-weight: 700;
    font-size: 15px;
    cursor: pointer;
    transition: all 0.25s ease;
    backdrop-filter: blur(4px);
}
.btn-see-all:hover { background: var(--white-32); border-color: rgba(255,255,255,0.7); transform: translateY(-2px); box-shadow: 0 8px 24px rgba(0,0,0,0.15); }

/* ==================== BOTONES RETROCESO ==================== */
.back-btn-fixed, .back-btn-inheader, .btn-back {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    background: var(--white-18);
    color: #ffffff;
    border: 1.5px solid var(--white-40);
    border-radius: 50%;
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    box-shadow: 0 3px 12px rgba(0, 0, 0, 0.15);
    cursor: pointer;
    transition: background 0.2s ease, transform 0.15s ease;
    will-change: transform;
}
.back-btn-fixed:hover, .back-btn-inheader:hover { background: var(--white-32); transform: translateY(-1px); }
.back-btn-fixed:active, .back-btn-inheader:active { transform: scale(0.95); }

.back-btn-fixed {
    position: fixed;
    top: 18px; left: 18px;
    z-index: 1000;
    width: 42px; height: 42px;
    font-size: 0.9rem;
    text-decoration: none;
    border: 1.5px solid var(--white-45);
    background: var(--white-22);
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
    transition: background 0.25s ease, transform 0.2s ease;
}
.back-btn-fixed:hover { background: rgba(255,255,255,0.38); }

.back-btn-inheader {
    flex-shrink: 0;
    width: 38px; height: 38px;
    font-size: 0.85rem;
    margin-right: 8px;
}

.btn-back {
    width: 38px; height: 38px;
    border-radius: 10px;
    border: 2px solid rgba(255,255,255,0.35);
    flex-shrink: 0;
}
.btn-back:hover { background: rgba(255,255,255,0.35); transform: translateX(-2px); }

/* ==================== HEADERS PÚRPURA ==================== */
.signup-header-purple, .form-header-purple {
    background: var(--grad-purple);
    padding: 32px;
    color: #ffffff;
    display: flex;
    align-items: center;
    position: relative;
}
.signup-header-purple { min-height: 160px; }
.form-header-purple   { min-height: 120px; }

.signup-header-content, .form-header-content { flex: 1; text-align: center; }

/* ==================== HEADER PRINCIPAL ==================== */
header.top-header {
    background: var(--grad-indigo);
    box-shadow: 0 10px 30px rgba(102,126,234,0.3);
    position: relative;
    overflow: hidden;
}
header.top-header > * { position: relative; z-index: 2; }
header.top-header h1 { color: white; text-shadow: 0 2px 8px rgba(0,0,0,0.2); }
header.top-header p { color: rgba(255,255,255,0.85); }
header.top-header .header-title-block h1 { font-size: 1.375rem !important; }

.header-action-buttons { display: flex; gap: 12px; align-items: center; }
.dashboard-section-title { color: white !important; }

.header-title-block {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    justify-content: center;
    min-width: 0;
}
.header-title-block h1 {
    white-space: normal;
    word-break: break-word;
    overflow-wrap: break-word;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    line-height: 1.25;
}

/* ==================== LOGO EN LOGIN ==================== */
.login-header-wrapper {
    padding: 0;
    background: linear-gradient(135deg, #9333ea 0%, var(--purple-1) 50%, var(--purple-2) 100%);
    text-align: center;
    color: white;
    position: relative;
    overflow: hidden;
}
.login-header-wrapper::after {
    content: '';
    position: absolute;
    top: -30%; left: -80%;
    width: 55%; height: 160%;
    background: linear-gradient(105deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.30) 45%, rgba(255,255,255,0.50) 50%, rgba(255,255,255,0.30) 55%, rgba(255,255,255,0) 100%);
    animation: cardShimmer 3.5s ease-in-out infinite;
    animation-delay: 0.8s;
    pointer-events: none;
    z-index: 5;
    transform: translateX(-120%) skewX(-15deg);
    opacity: 0;
    will-change: transform, opacity;
}
.login-logo-wrap {
    width: 100%;
    overflow: hidden;
    border-radius: 0;
    height: clamp(160px, 28vw, 240px);
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
}
.login-logo-img {
    width: 100%; height: 100%;
    object-fit: contain;
    object-position: center;
    display: block;
    padding: 12px;
    position: relative;
    z-index: 6;
}
.login-text-wrap { padding: 0 32px 28px; position: relative; z-index: 6; }

/* ==================== LOGIN: FILA DE BOTONES ==================== */
.login-btn-row { display: flex; gap: 10px; align-items: stretch; }
.login-btn-main { flex: 1.4; }

.login-btn-register {
    flex: 1;
    background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
    color: #ffffff;
    border: none;
    border-radius: 12px;
    font-size: 0.85rem;
    font-weight: 700;
    padding: 0 14px;
    cursor: pointer;
    transition: all 0.2s ease;
    white-space: nowrap;
    box-shadow: 0 3px 10px rgba(22,163,74,0.4);
}
.login-btn-register:hover { background: linear-gradient(135deg, #16a34a 0%, #15803d 100%); transform: translateY(-1px); box-shadow: 0 6px 18px rgba(22,163,74,0.5); }
.login-btn-register:active { transform: translateY(0); }

.login-btn-cancel {
    flex: 1;
    background: var(--grad-red);
    color: #ffffff;
    border: none;
    border-radius: 12px;
    font-size: 0.85rem;
    font-weight: 700;
    padding: 0 14px;
    cursor: pointer;
    transition: all 0.2s ease;
    white-space: nowrap;
    box-shadow: 0 2px 8px rgba(220, 38, 38, 0.25);
}
.login-btn-cancel:hover { background: linear-gradient(135deg, var(--red-2) 0%, var(--red-3) 100%); transform: translateY(-1px); box-shadow: 0 4px 12px rgba(220, 38, 38, 0.35); }
.login-btn-cancel:active { transform: translateY(0); }

.login-forgot-link {
    background: none;
    border: none;
    padding: 0;
    cursor: pointer;
    color: var(--red-1);
    font-weight: 700;
    font-size: 0.875rem;
    text-decoration: underline;
    text-underline-offset: 2px;
    transition: color 0.2s ease;
}
.login-forgot-link:hover { color: var(--red-2); }

/* ==================== ACCESO INVITADO ==================== */
.guest-access-link {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    color: var(--green-1);
    font-weight: 700;
    font-size: 15px;
    text-decoration: none;
    padding: 8px 16px;
    border-radius: 8px;
    transition: all 0.3s ease;
    background: rgba(34,197,94,0.1);
    border: 2px solid transparent;
    animation: guestGlow 2s ease-in-out infinite;
    will-change: text-shadow;
}
.guest-access-link:hover { background: rgba(34,197,94,0.2); border-color: var(--green-1); transform: scale(1.05); }
.guest-access-link .hand-icon { animation: pointingHand 1s ease-in-out infinite; font-size: 18px; }

.guest-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    background: var(--grad-green);
    color: white;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 700;
    box-shadow: 0 2px 8px rgba(34,197,94,0.3);
}

/* ==================== BARRA DE ACCIÓN RÁPIDA ==================== */
.quick-action-bar {
    display: flex;
    gap: 12px;
    padding: 12px 16px;
    background: rgba(0,0,0,0.12);
    border-bottom: 1px solid rgba(255,255,255,0.12);
    justify-content: center;
    align-items: center;
}
.quick-action-hand { font-size: 22px; animation: pointingHand 1s ease-in-out 3; flex-shrink: 0; line-height: 1; display: inline-block; }

.quick-btn {
    padding: 9px 14px;
    border-radius: 14px;
    font-weight: 700;
    font-size: 13px;
    cursor: pointer;
    border: none;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    white-space: nowrap;
    will-change: transform;
}
.quick-btn-red, .quick-btn-blue, .quick-btn-purple { color: #fff; }
.quick-btn-red:hover, .quick-btn-blue:hover, .quick-btn-purple:hover { transform: translateY(-2px); }

.quick-btn-red { background: #c01e1e; border: 1.5px solid rgba(255,100,100,0.4); box-shadow: 0 3px 10px rgba(180,20,20,0.35); }
.quick-btn-red:hover { background: #a81818; box-shadow: 0 6px 18px rgba(180,20,20,0.45); }
.quick-btn-blue { background: #1a52d4; border: 1.5px solid rgba(100,150,255,0.4); box-shadow: 0 3px 10px rgba(25,75,210,0.35); }
.quick-btn-blue:hover { background: #1542b8; box-shadow: 0 6px 18px rgba(25,75,210,0.45); }
.quick-btn-purple { background: var(--purple-2); border: 1.5px solid rgba(167,139,250,0.4); box-shadow: 0 3px 10px rgba(109,40,217,0.35); }
.quick-btn-purple:hover { background: var(--purple-3); box-shadow: 0 6px 18px rgba(109,40,217,0.45); }

/* ==================== MODALES ==================== */
.modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.5);
    backdrop-filter: blur(6px);
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
}
.modal-window {
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    max-width: 440px;
    width: 100%;
    overflow: hidden;
    border: 1px solid rgba(0,0,0,0.1);
    animation: modalPop 0.25s cubic-bezier(0.25,0.46,0.45,0.94);
    will-change: transform, opacity;
}
.modal-header {
    background: #fff;
    color: var(--gray-800);
    padding: 20px 24px 16px;
    display: flex;
    align-items: flex-start;
    gap: 16px;
    border-bottom: 1px solid var(--gray-200);
}
.modal-header i { font-size: 24px; color: var(--indigo-1); margin-top: 2px; }
.modal-header .header-text h3 { font-size: 16px; font-weight: 600; color: var(--gray-800); margin: 0 0 4px 0; }
.modal-header .header-text p { font-size: 14px; color: var(--gray-500); margin: 0; }
.modal-header .header-text { flex: 1; }

.modal-header-success, .modal-header-question { background: rgba(34,197,94,0.15); border-bottom: 1px solid rgba(34,197,94,0.25); }
.modal-header-error   { background: rgba(239,68,68,0.15);  border-bottom: 1px solid rgba(239,68,68,0.25); }
.modal-header-warning { background: rgba(245,158,11,0.15); border-bottom: 1px solid rgba(245,158,11,0.25); }
.modal-header-info    { background: rgba(59,130,246,0.15); border-bottom: 1px solid rgba(59,130,246,0.25); }

.modal-body { padding: 20px 24px; line-height: 1.6; color: var(--gray-700); font-size: 14px; }
.modal-footer { padding: 16px 24px; background: var(--gray-100); display: flex; gap: 8px; justify-content: flex-end; border-top: 1px solid var(--gray-200); }

/* ==================== FORMULARIOS E INPUTS ==================== */
.input-group { position: relative; margin-bottom: 20px; }
.input-group input, .input-group textarea, .input-group select {
    width: 100%;
    padding: 14px 16px;
    border: 2px solid #e9ecef;
    border-radius: 10px;
    font-size: 14px;
    transition: all 0.2s;
    font-family: inherit;
    background: linear-gradient(to bottom, #ffffff 0%, var(--gray-100) 100%);
}
.input-group input:focus, .input-group textarea:focus, .input-group select:focus {
    outline: none;
    border-color: var(--indigo-1);
    box-shadow: 0 0 0 4px rgba(102,126,234,0.1);
}
.input-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #495057; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; }
.input-icon { position: absolute; right: 16px; top: 42px; cursor: pointer; color: #6c757d; transition: color 0.2s; user-select: none; }
.input-icon:hover { color: var(--indigo-1); }
textarea { box-shadow: 0 2px 6px rgba(0,0,0,0.1); }

/* ==================== REQUIREMENTS TEXTAREA ==================== */
.req-hint { font-size: 11px; color: var(--gray-400); font-weight: 400; font-style: italic; margin-left: 6px; }
.requirements-textarea-wrap { position: relative; }
.requirements-input {
    width: 100%;
    padding: 14px 16px;
    border: 2px solid #e9ecef;
    border-radius: 10px 10px 0 0;
    font-size: 14px;
    font-family: inherit;
    resize: vertical;
    background: linear-gradient(to bottom, #ffffff 0%, var(--gray-100) 100%);
    transition: all 0.2s;
    line-height: 1.7;
    color: var(--gray-700);
    border-bottom: 1px dashed #e9ecef;
}
.requirements-input:focus {
    outline: none;
    border-color: var(--indigo-1);
    box-shadow: 0 0 0 4px rgba(102,126,234,0.1);
    border-bottom: 1px dashed var(--indigo-1);
}
.req-lines-preview {
    background: #f8f7ff;
    border: 2px solid #e9ecef;
    border-top: none;
    border-radius: 0 0 10px 10px;
    padding: 10px 14px;
    min-height: 44px;
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    align-items: flex-start;
    transition: border-color 0.2s;
}
.requirements-input:focus + .req-lines-preview,
.requirements-textarea-wrap:focus-within .req-lines-preview { border-color: var(--indigo-1); }
.req-pill {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    background: white;
    border: 1.5px solid rgba(102,126,234,0.3);
    color: var(--gray-600);
    padding: 3px 10px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 500;
    line-height: 1.5;
}
.req-pill::before { content: '✓'; color: var(--indigo-1); font-weight: 700; font-size: 11px; }
.req-empty-hint { font-size: 12px; color: var(--purple-xlight); font-style: italic; padding: 4px 6px; }

/* ==================== FORMULARIO — LAYOUT DE BOTONES ==================== */
.form-buttons-container { display: flex; flex-direction: column; gap: 12px; padding-top: 20px; }
.form-main-buttons { display: flex; gap: 8px; width: 100%; }
.form-main-buttons .btn-compact { flex: 1; min-width: 0; padding: 10px 6px; font-size: 13px; white-space: nowrap; }
.form-ai-button { width: 100%; justify-content: center; }

/* ==================== SUBIDA DE IMÁGENES ==================== */
.image-upload-area {
    border: 2px dashed var(--gray-300);
    border-radius: 12px;
    padding: 40px;
    text-align: center;
    background: var(--gray-100);
    transition: all 0.3s ease;
    cursor: pointer;
    position: relative;
}
.image-upload-area:hover { border-color: var(--indigo-1); background: #f3f4f6; }
.image-upload-area.has-image { padding: 0; border: none; }
.image-upload-area > div, .image-upload-area > div * { pointer-events: none; }
.image-preview-container { width: 100%; height: 200px; overflow: hidden; border-radius: 12px; position: relative; }
.image-preview-container img { width: 100%; height: 100%; object-fit: cover; display: block; }

/* ==================== TARJETAS DE VACANTES ==================== */
.vacancy-card {
    background: linear-gradient(145deg, #ffffff 0%, var(--gray-100) 100%);
    border-radius: 24px;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    transition: transform 0.3s cubic-bezier(0.4,0,0.2,1), box-shadow 0.3s cubic-bezier(0.4,0,0.2,1);
    border: 2px solid rgba(102,126,234,0.1);
    display: flex;
    flex-direction: column;
    will-change: transform;
}
.vacancy-card:hover { transform: translateY(-8px); box-shadow: 0 20px 50px rgba(102,126,234,0.25); border-color: rgba(102,126,234,0.3); }

/* FIX: reducir padding top del contenido para acercar empresa a imagen */
.vacancy-card .card-content { padding: 14px 20px 20px; display: flex; flex-direction: column; flex: 1; }
.vacancy-card .card-info-rows, .vacancy-card .btn-whatsapp-card, .vacancy-card .flex.gap-2 { margin-top: auto; }

/* ── imagen de card con altura proporcional, sin corte ── */
.card-img-wrap {
    width: 100%;
    aspect-ratio: 4 / 3;
    overflow: hidden;
    background: var(--gray-200);
    position: relative;
}
.card-img-wrap img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    object-position: center;
    display: block;
}
.card-img-placeholder {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--gray-400);
    font-size: 2rem;
}

.card-description { font-size: 14px; font-weight: 700; color: var(--gray-700); line-height: 1.55; margin-bottom: 0; }
.req-block-title { font-size: 11px; font-weight: 700; color: var(--gray-500); text-transform: uppercase; letter-spacing: 0.6px; margin-bottom: 8px; }
.card-info-rows { display: flex; flex-direction: column; gap: 6px; }
.card-info-row { display: flex; align-items: flex-start; gap: 8px; font-size: 13px; color: #4b5563; line-height: 1.5; }
.card-info-row i { color: var(--indigo-1); font-size: 12px; margin-top: 2px; flex-shrink: 0; width: 14px; text-align: center; }
.card-info-row span { flex: 1; word-break: break-word; overflow-wrap: break-word; white-space: normal; min-width: 0; }
.card-company { font-size: 1.1rem; font-weight: 800; color: var(--gray-900); margin-bottom: 5px; line-height: 1.3; word-break: break-word; overflow-wrap: break-word; white-space: normal; }
.job-title { word-break: break-word; overflow-wrap: break-word; white-space: normal; line-height: 1.4; }

/* ==================== LISTA DE REQUISITOS EN CARDS ==================== */
.requirements-block { background: #f8f7ff; border: 1px solid rgba(102,126,234,0.15); border-radius: 10px; padding: 10px 14px; }
.requirements-list { list-style: none; padding: 0; margin: 0; }
.requirements-list li { font-size: 13px; color: var(--gray-700); padding: 3px 0 3px 18px; position: relative; line-height: 1.5; }
.requirements-list li::before { content: '✓'; position: absolute; left: 0; color: var(--indigo-1); font-weight: 700; font-size: 12px; }

/* ==================== PANTALLA DE CATEGORÍAS ==================== */
.categories-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 10px; }
.categories-screen-bg { background: #fff; min-height: 100vh; }
.categories-screen-bg .cat-screen-title { color: var(--purple-2); text-shadow: none; font-size: 1.375rem; font-weight: 900; text-align: center; letter-spacing: 0.2px; }

/* ==================== CARDS DE CATEGORÍA V2 ==================== */
.category-card-v2 {
    display: flex;
    align-items: center;
    gap: 14px;
    background: linear-gradient(135deg, var(--cat-c1, var(--purple-1)), var(--cat-c2, var(--purple-light)) 70%, rgba(255,255,255,0.18) 100%);
    border: none;
    border-radius: 14px;
    padding: 11px 16px;
    cursor: pointer;
    transition: transform 0.22s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.22s cubic-bezier(0.4, 0, 0.2, 1);
    text-align: left;
    position: relative;
    overflow: hidden;
    width: 100%;
    box-shadow: 0 4px 14px rgba(0,0,0,0.28), 0 1px 3px rgba(0,0,0,0.18), inset 0 1px 0 rgba(255,255,255,0.35), inset 0 -1px 0 rgba(0,0,0,0.12);
    will-change: transform;
}
.cat-all { padding: 13px 18px; box-shadow: 0 6px 20px rgba(124,58,237,0.45), inset 0 1px 0 rgba(255,255,255,0.3); }

.category-card-v2::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 48%;
    background: linear-gradient(to bottom, rgba(255,255,255,0.28) 0%, rgba(255,255,255,0) 100%);
    border-radius: 14px 14px 0 0;
    pointer-events: none;
    z-index: 1;
}
.category-card-v2::after {
    content: '';
    position: absolute;
    top: -30%; left: -80%;
    width: 55%; height: 160%;
    background: linear-gradient(105deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.32) 45%, rgba(255,255,255,0.52) 50%, rgba(255,255,255,0.32) 55%, rgba(255,255,255,0) 100%);
    transform: translateX(-120%) skewX(-15deg);
    transition: transform 0.55s ease, opacity 0.55s ease;
    opacity: 0;
    pointer-events: none;
    z-index: 3;
    will-change: transform, opacity;
}
.category-card-v2:hover::after { transform: translateX(280%) skewX(-15deg); opacity: 1; }
.category-card-v2 > * { position: relative; z-index: 4; }
.category-card-v2:hover { transform: translateY(-3px) scale(1.012); box-shadow: 0 10px 28px rgba(0,0,0,0.32), 0 2px 6px rgba(0,0,0,0.18), inset 0 1px 0 rgba(255,255,255,0.42), inset 0 -1px 0 rgba(0,0,0,0.12); }
.category-card-v2:active { transform: translateY(0) scale(0.98); box-shadow: 0 2px 8px rgba(0,0,0,0.22), inset 0 1px 0 rgba(255,255,255,0.28); }

.cat-v2-icon-wrap { width: 42px; height: 42px; border-radius: 10px; background: rgba(255,255,255,0.22); display: flex; align-items: center; justify-content: center; flex-shrink: 0; backdrop-filter: blur(4px); border: 1px solid rgba(255,255,255,0.3); }
.cat-v2-icon-wrap i { font-size: 18px; color: #ffffff; }
.cat-v2-info { flex: 1; min-width: 0; text-align: center; }
.cat-v2-name { display: block; font-weight: 700; font-size: 17px; color: #ffffff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-shadow: 0 1px 4px rgba(0,0,0,0.2); }
.cat-v2-count { display: block; font-size: 13px; color: rgba(255,255,255,0.82); margin-top: 2px; font-weight: 500; }
.cat-v2-arrow { color: rgba(255,255,255,0.7); font-size: 13px; flex-shrink: 0; transition: transform 0.2s ease; }
.category-card-v2:hover .cat-v2-arrow { transform: translateX(4px); color: white; }

/* ==================== LOADER ==================== */
.loader { border: 4px solid rgba(102,126,234,0.2); border-top: 4px solid var(--indigo-1); border-radius: 50%; width: 50px; height: 50px; animation: spin 0.8s linear infinite; margin: 20px auto; will-change: transform; }

/* ==================== CALENDARIO ==================== */
.calendar-modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 16px; box-shadow: 0 25px 80px rgba(0,0,0,0.3); z-index: 10001; padding: 24px; max-width: 400px; width: 90%; animation: modalPop 0.3s ease-out; }
.calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 2px solid var(--gray-200); }
.calendar-header h3 { font-size: 18px; font-weight: 700; color: var(--gray-800); }
.calendar-nav { display: flex; gap: 12px; align-items: center; }
.calendar-nav button { background: #f3f4f6; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s; }
.calendar-nav button:hover { background: var(--gray-200); }
.calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin-top: 16px; }
.calendar-day { text-align: center; padding: 12px 8px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.2s; }
.calendar-day.header { color: var(--gray-500); font-size: 12px; font-weight: 700; cursor: default; padding: 8px; }
.calendar-day:not(.header):hover { background: #f3f4f6; }
.calendar-day.selected { background: var(--indigo-1); color: white; }
.calendar-day.today { border: 2px solid var(--indigo-1); }
.calendar-day.disabled { color: var(--gray-300); cursor: not-allowed; }
.calendar-day.disabled:hover { background: transparent; }
.calendar-actions { display: flex; gap: 12px; margin-top: 20px; padding-top: 16px; border-top: 2px solid var(--gray-200); }
.calendar-actions button { flex: 1; }

/* ==================== CHAT IA ==================== */
.ai-chat-modal { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 400px; max-height: 600px; z-index: 9999; animation: slideUp 0.4s ease-out; background: white; border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.4); border: 2px solid rgba(0,0,0,0.2); will-change: transform; }
.ai-chat-modal.minimized { width: 280px; height: 60px; max-height: 60px; }
.ai-chat-modal.minimized .ai-chat-messages, .ai-chat-modal.minimized .ai-chat-input { display: none; }
.ai-chat-modal.minimized .ai-chat-header { border-radius: 16px; }

.ai-chat-header { background: var(--grad-dark); color: var(--gold); padding: 16px 20px; border-radius: 16px 16px 0 0; display: flex; justify-content: space-between; align-items: center; cursor: move; font-weight: 700; font-size: 18px; }
.ai-chat-header h3 { margin: 0; color: var(--gold); }
.ai-chat-header .close-btn { background: var(--white-10); border: none; color: var(--gold); width: 32px; height: 32px; border-radius: 50%; cursor: pointer; transition: all 0.3s ease; margin-left: 12px; }
.ai-chat-header .close-btn:hover { background: rgba(255,215,0,0.2); transform: rotate(90deg); }

.ai-chat-messages { background: linear-gradient(145deg, #0f172a 0%, #1f2937 100%); padding: 20px; max-height: 300px; overflow-y: auto; border-left: 2px solid var(--gold); border-right: 2px solid var(--gold); }
.ai-message { margin-bottom: 16px; padding: 12px 16px; border-radius: 12px; max-width: 90%; word-wrap: break-word; font-size: 14px; line-height: 1.5; }
.ai-message.user { background: var(--grad-blue); color: white; margin-left: auto; border-top-right-radius: 4px; }
.ai-message.bot { background: linear-gradient(135deg, #1f2937 0%, #334155 100%); color: var(--gold); border-top-left-radius: 4px; border-left: 3px solid var(--gold); }

.ai-loading { display: inline-block; width: 20px; height: 20px; border: 3px solid var(--gold-dim); border-top-color: var(--gold); border-radius: 50%; animation: spin 1s linear infinite; will-change: transform; }

.ai-chat-input { background: linear-gradient(135deg, #1f2937 0%, #0f172a 100%); padding: 16px; border-radius: 0 0 16px 16px; }
.ai-chat-input textarea { width: 100%; padding: 12px 16px; border: 2px solid var(--gold); border-radius: 12px; background: rgba(255,255,255,0.1); color: white; resize: none; font-family: inherit; font-size: 14px; transition: all 0.3s ease; }
.ai-chat-input textarea:focus { outline: none; border-color: var(--gold); box-shadow: 0 0 15px rgba(255,215,0,0.5); }
.ai-chat-input textarea::placeholder { color: rgba(255,255,255,0.5); }

.ai-chat-actions { display: flex; gap: 12px; margin-top: 12px; }
.ai-chat-actions button { flex: 1; padding: 12px 16px; border: none; border-radius: 12px; font-weight: 700; font-size: 14px; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 8px; }
.ai-chat-actions button:disabled { opacity: 0.5; cursor: not-allowed; }

.ai-chat-actions .btn-send { background: linear-gradient(135deg, var(--blue-2) 0%, var(--blue-4) 100%); color: white; }
.ai-chat-actions .btn-send:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(37,99,235,0.4); }
.ai-chat-actions .btn-start { background: linear-gradient(135deg, var(--green-2) 0%, #15803d 100%); color: white; animation: pulse 2s infinite; }
.ai-chat-actions .btn-start:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(22,163,74,0.4); }
.ai-chat-actions .btn-close-chat { background: var(--grad-red); color: white; }
.ai-chat-actions .btn-close-chat:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(220,38,38,0.4); }

.ai-chat-input .file-upload { display: flex; align-items: center; gap: 12px; margin-top: 12px; }
.ai-chat-input .file-upload label { background: rgba(255,215,0,0.2); color: var(--gold); padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 12px; transition: all 0.3s ease; border: 1px solid rgba(255,215,0,0.3); }
.ai-chat-input .file-upload label:hover { background: var(--gold-dim); transform: translateY(-1px); }
.ai-chat-input .file-upload input { display: none; }
.ai-chat-input .file-preview { display: flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.1); padding: 8px 12px; border-radius: 8px; margin-top: 8px; border: 1px solid rgba(255,215,0,0.2); }
.ai-chat-input .file-preview img { width: 40px; height: 40px; object-fit: cover; border-radius: 6px; }
.ai-chat-input .file-preview .remove-file { background: rgba(255,0,0,0.3); color: white; border: none; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; font-size: 12px; }

/* ==================== SCROLLBAR ==================== */
::-webkit-scrollbar { width: 12px; }
::-webkit-scrollbar-track { background: #f1f1f1; }
::-webkit-scrollbar-thumb { background: var(--grad-indigo); border-radius: 6px; }

/* ==================== UTILIDADES ==================== */
.line-clamp-3 { display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
.truncate { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

/* ==================== CONTADOR DE VISITAS ==================== */
.visit-counter-bar {
    position: fixed;
    bottom: 0; left: 0; right: 0;
    z-index: 8000;
    background: linear-gradient(135deg, #1e1b4b 0%, #312e81 50%, #4c1d95 100%);
    border-top: 1px solid rgba(167,139,250,0.35);
    padding: 8px 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    box-shadow: 0 -4px 20px rgba(79,70,229,0.3);
    backdrop-filter: blur(8px);
}
.visit-counter-icon { font-size: 22px; flex-shrink: 0; }
.visit-counter-text { font-size: 13px; color: rgba(255,255,255,0.85); font-weight: 500; letter-spacing: 0.2px; }
.visit-counter-number { font-size: 17px; font-weight: 900; color: #fbbf24; letter-spacing: 1px; text-shadow: 0 0 16px rgba(251,191,36,0.7), 0 0 30px rgba(251,191,36,0.3); font-variant-numeric: tabular-nums; min-width: 54px; text-align: center; display: inline-block; }
.visit-counter-dot { width: 5px; height: 5px; border-radius: 50%; background: rgba(167,139,250,0.7); flex-shrink: 0; box-shadow: 0 0 6px rgba(167,139,250,0.5); }

.quick-btn-wide { padding: 9px 28px; font-size: 14px; min-width: 140px; }

/* ==================== BOTÓN DESCARGAR CARD ==================== */
.btn-download-card {
    position: absolute;
    top: 12px; right: 12px;
    z-index: 10;
    width: 36px; height: 36px;
    border-radius: 50%;
    border: none;
    background: rgba(56, 189, 248, 0.55);
    backdrop-filter: blur(6px);
    -webkit-backdrop-filter: blur(6px);
    color: #ffffff;
    font-size: 15px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 8px rgba(14, 165, 233, 0.35);
    transition: background 0.2s ease, transform 0.15s ease, box-shadow 0.2s ease;
    will-change: transform;
}
.btn-download-card:hover { background: rgba(14, 165, 233, 0.80); transform: scale(1.1); box-shadow: 0 4px 16px rgba(14, 165, 233, 0.5); color: #ffffff; }
.btn-download-card:active { transform: scale(0.95); }
.btn-download-card.downloading { background: rgba(14, 165, 233, 0.35); color: #fff; pointer-events: none; }

/* ==================== BADGE DE CATEGORÍA SOBRE IMAGEN ==================== */
.card-category-badge {
    position: absolute;
    top: 12px; left: 12px;
    z-index: 10;
    display: inline-flex;
    align-items: center;
    gap: 5px;
    background: rgba(109, 40, 217, 0.72);
    backdrop-filter: blur(6px);
    -webkit-backdrop-filter: blur(6px);
    color: #ffffff;
    font-size: 11px;
    font-weight: 700;
    padding: 5px 10px;
    border-radius: 20px;
    box-shadow: 0 2px 8px rgba(109, 40, 217, 0.4);
    letter-spacing: 0.3px;
    white-space: nowrap;
    max-width: calc(100% - 64px);
    overflow: hidden;
    text-overflow: ellipsis;
    pointer-events: none;
}

/* ==================== FILA TÍTULO + META DATOS FIJOS ==================== */
.card-title-meta-row {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 10px;
    margin-bottom: 10px;
}
.card-title-meta-row .job-title { flex: 1; min-width: 0; margin-bottom: 0; }
.job-title-prefix {
    font-weight: 900;
    color: var(--gray-800);
    font-size: 0.78rem;
    text-transform: uppercase;
    letter-spacing: 0.4px;
    display: block;
    margin-bottom: 1px;
}

/* FIX UBICACIÓN: dos líneas — calle arriba, colonia abajo */
.card-meta-inline {
    display: flex;
    flex-direction: column;
    gap: 4px;
    flex-shrink: 0;
    align-items: flex-end;
    max-width: 48%;
}
.card-meta-item {
    display: inline-flex;
    align-items: flex-start;
    gap: 5px;
    font-size: 11.5px;
    color: var(--gray-600);
    /* SIN white-space:nowrap para permitir wrap en ubicación */
    word-break: break-word;
    overflow-wrap: break-word;
    max-width: 100%;
    text-align: right;
}
.card-meta-item i {
    color: var(--indigo-1);
    font-size: 10px;
    flex-shrink: 0;
    width: 12px;
    text-align: center;
    margin-top: 2px;
}
/* Línea de colonia/segunda parte de dirección */
.card-meta-loc-street  { font-weight: 600; display: block; }
.card-meta-loc-colony  { display: block; font-size: 10.5px; color: var(--gray-500); line-height: 1.3; }

/* ==================== FOOTER MARQUEE ==================== */
.app-footer { overflow: hidden; white-space: nowrap; margin-top: 32px; padding: 10px 0; border-top: 1px solid rgba(109,40,217,0.12); }
.app-footer-inner { display: inline-block; animation: marqueeScroll 18s linear infinite; color: var(--gray-400); font-size: 13px; font-weight: 500; will-change: transform; }

/* ==================== USER SESSION BADGE ==================== */
.user-session-badge { background: #f8f7ff; }
.session-label { font-size: 11px; color: var(--gray-400); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
.session-email { font-size: 13px; color: var(--purple-1); font-weight: 600; }
    </style>
</head>
<body>
    <div id="app"></div>
    <div id="modal-root"></div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script>
// ==================== ENDPOINTS ====================
const ENDPOINTS = {
    SUPABASE_URL: 'https://mecrloufrzbfcihioeve.supabase.co',
    SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1lY3Jsb3VmcnpiZmNpaGlvZXZlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3NTM2OTgsImV4cCI6MjA4NjMyOTY5OH0.Gs36EkNHv5vG2CPdrK7XtCnWvX5NYkyPY9moTdezbVA',
    SUPABASE_REDIRECT_URL: 'https://compualextech24.github.io/empleosdeleongtoaxel/',
    AI_EXTRACT_VACANCY: '/functions/v1/extract-vacancy',
    TABLES:   { VACANCIES: 'vacancies' },
    CHANNELS: { VACANCIES: 'vacancies' }
};

const EndpointHelpers = {
    getEdgeFunctionUrl: (fp) => `${ENDPOINTS.SUPABASE_URL}${fp}`,
    getAIExtractUrl:    ()   => `${ENDPOINTS.SUPABASE_URL}${ENDPOINTS.AI_EXTRACT_VACANCY}`
};

window.ENDPOINTS       = ENDPOINTS;
window.EndpointHelpers = EndpointHelpers;

// ==================== SUPABASE CLIENT ====================
const { createClient } = supabase;
const supabaseClient = createClient(ENDPOINTS.SUPABASE_URL, ENDPOINTS.SUPABASE_ANON_KEY);

// ==================== ESTADO GLOBAL ====================
let state = {
    view: 'login',
    user: null,
    isGuest: false,
    vacancies: [],
    filteredVacancies: [],
    selectedCategory: null,
    dateFilter: null,
    editingVacancy: null,
    showPassword: false,
    showConfirmPassword: false,
    menuOpen: false,
    acceptedTerms: false,
    loading: false,
    isRendering: false,
    calendarOpen: false,
    calendarMonth: new Date().getMonth(),
    calendarYear: new Date().getFullYear(),
    formData: {
        email: '', password: '', confirmPassword: '',
        company: '', job_title: '', description: '',
        location: '', contact_phone: '', publication_date: '',
        schedule: '', work_days: '', category: '',
        imageBase64: '',
        requirements: 'Disponibilidad y actitud de trabajar'
    },
    aiChatOpen: false,
    aiMessages: [],
    aiLoading: false,
    aiImage: null,
    aiImagePreview: null,
    aiExtractedData: null,
    chatMinimized: false,
    isLoggingOut: false
};

// ==================== cleanValue ====================
const cleanValue = (val) => {
    if (val === null || val === undefined) return '';
    const s = String(val).trim();
    if (s === 'NULL' || s === 'null' || s === 'undefined' || s === 'NaN') return '';
    return s;
};

// ==================== UTILIDADES ====================
const showLoading = () => {
    if (document.getElementById('loader-overlay')) return;
    state.loading = true;
    const loader = document.createElement('div');
    loader.id = 'loader-overlay';
    loader.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:9999;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(4px)';
    loader.innerHTML = '<div class="loader"></div>';
    document.body.appendChild(loader);
};

const hideLoading = () => {
    state.loading = false;
    document.querySelectorAll('#loader-overlay').forEach(el => el.remove());
};

const escapeHtml = (text) => {
    if (!text) return '';
    const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' };
    return String(text).replace(/[&<>"']/g, m => map[m]);
};

// ==================== render() con debounce ====================
let _renderTimer = null;

function render(immediate) {
    if (immediate) { _doRender(); return; }
    clearTimeout(_renderTimer);
    _renderTimer = setTimeout(_doRender, 16);
}

function _doRender() {
    if (state.isRendering) return;
    state.isRendering = true;
    try {
        const app = document.getElementById('app');
        if (!app) return;
        let content = '';
        switch (state.view) {
            case 'login':      content = renderLogin();      break;
            case 'signup':     content = renderSignup();     break;
            case 'terms':      content = renderTerms();      break;
            case 'categories': content = renderCategories(); break;
            case 'dashboard':  content = renderDashboard();  break;
            case 'form':       content = renderForm();       break;
            default:           content = renderLogin();
        }
        app.innerHTML = content + renderCalendar();
        attachEvents();
        window.scrollTo({ top: 0, behavior: 'smooth' });
    } catch (err) {
        console.error('❌ Error en render:', err);
    } finally {
        state.isRendering = false;
    }
}

// ==================== MODAL ====================
const showModal = (type, title, message, onConfirm = null) => {
    const modal = document.createElement('div');
    modal.className = 'modal-overlay';

    const icons   = { success: 'fa-check-circle', error: 'fa-exclamation-circle', warning: 'fa-exclamation-triangle', info: 'fa-info-circle', question: 'fa-question-circle', 'question-danger': 'fa-exclamation-triangle' };
    const colors  = { success: '#22c55e', error: '#ef4444', warning: '#f59e0b', info: '#3b82f6', question: '#22c55e', 'question-danger': '#ef4444' };
    const headerClass = type === 'question-danger' ? 'modal-header-error' : `modal-header-${type}`;
    const isQuestion = type === 'question' || type === 'question-danger';

    modal.innerHTML = `
        <div class="modal-window">
            <div class="modal-header ${headerClass}">
                <i class="fas ${icons[type]}" style="color:${colors[type]}"></i>
                <div class="header-text"><h3>${escapeHtml(title)}</h3></div>
            </div>
            <div class="modal-body">${escapeHtml(message)}</div>
            <div class="modal-footer">
                ${isQuestion
                    ? '<button class="btn btn-cancel modal-cancel">Cancelar</button><button class="btn btn-primary modal-confirm">Aceptar</button>'
                    : '<button class="btn btn-primary modal-ok">Aceptar</button>'
                }
            </div>
        </div>`;

    document.getElementById('modal-root').appendChild(modal);

    if (isQuestion) {
        modal.querySelector('.modal-cancel').onclick  = () => modal.remove();
        modal.querySelector('.modal-confirm').onclick = () => { modal.remove(); if (onConfirm) onConfirm(); };
    } else {
        modal.querySelector('.modal-ok').onclick = () => modal.remove();
        setTimeout(() => modal.remove(), 8000);
    }
    modal.onclick = (e) => { if (e.target === modal && !isQuestion) modal.remove(); };
};

// ==================== CALENDARIO ====================
function openCalendar()  { state.calendarOpen = true; state.calendarMonth = new Date().getMonth(); state.calendarYear = new Date().getFullYear(); render(); }
function closeCalendar() { state.calendarOpen = false; render(); }

function changeMonth(delta) {
    state.calendarMonth += delta;
    if (state.calendarMonth > 11) { state.calendarMonth = 0;  state.calendarYear++; }
    else if (state.calendarMonth < 0)  { state.calendarMonth = 11; state.calendarYear--; }
    render();
}

function selectDate(year, month, day) {
    state.dateFilter = new Date(year, month, day);
    filterVacanciesByDate();
    closeCalendar();
    showModal('success', 'Filtro aplicado', `Mostrando vacantes del ${day}/${month + 1}/${year}`);
}

function clearDateFilter() {
    state.dateFilter = null;
    state.filteredVacancies = [...state.vacancies];
    closeCalendar();
    render();
    showModal('info', 'Filtro eliminado', 'Mostrando todas las vacantes');
}

function filterVacanciesByDate() {
    if (!state.dateFilter) { state.filteredVacancies = [...state.vacancies]; return; }
    const filterDate = state.dateFilter.toLocaleDateString('es-MX');
    state.filteredVacancies = state.vacancies.filter(v => {
        if (!v.created_at) return false;
        return new Date(v.created_at).toLocaleDateString('es-MX') === filterDate;
    });
    render();
}

function renderCalendar() {
    if (!state.calendarOpen) return '';
    const monthNames = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
    const firstDay    = new Date(state.calendarYear, state.calendarMonth, 1).getDay();
    const daysInMonth = new Date(state.calendarYear, state.calendarMonth + 1, 0).getDate();
    const today = new Date();
    const isCurrentMonth = today.getMonth() === state.calendarMonth && today.getFullYear() === state.calendarYear;

    let html = `
        <div class="modal-overlay" onclick="if(event.target===this)closeCalendar()">
            <div class="calendar-modal">
                <div class="calendar-header">
                    <h3><i class="fas fa-calendar-alt mr-2"></i>${monthNames[state.calendarMonth]} ${state.calendarYear}</h3>
                    <div class="calendar-nav">
                        <button onclick="changeMonth(-1)"><i class="fas fa-chevron-left"></i></button>
                        <button onclick="changeMonth(1)"><i class="fas fa-chevron-right"></i></button>
                    </div>
                </div>
                <div class="calendar-grid">
                    <div class="calendar-day header">D</div><div class="calendar-day header">L</div>
                    <div class="calendar-day header">M</div><div class="calendar-day header">M</div>
                    <div class="calendar-day header">J</div><div class="calendar-day header">V</div>
                    <div class="calendar-day header">S</div>`;

    for (let i = 0; i < firstDay; i++) html += '<div class="calendar-day"></div>';
    for (let day = 1; day <= daysInMonth; day++) {
        const isToday    = isCurrentMonth && day === today.getDate();
        const isSelected = state.dateFilter && state.dateFilter.getDate() === day && state.dateFilter.getMonth() === state.calendarMonth && state.dateFilter.getFullYear() === state.calendarYear;
        html += `<div class="calendar-day ${isToday ? 'today' : ''} ${isSelected ? 'selected' : ''}" onclick="selectDate(${state.calendarYear},${state.calendarMonth},${day})">${day}</div>`;
    }

    html += `</div>
                <div class="calendar-actions">
                    <button class="btn btn-cancel" onclick="clearDateFilter()"><i class="fas fa-times"></i> Limpiar</button>
                    <button class="btn btn-primary" onclick="closeCalendar()"><i class="fas fa-check"></i> Cerrar</button>
                </div>
            </div>
        </div>`;
    return html;
}

window.openCalendar    = openCalendar;
window.closeCalendar   = closeCalendar;
window.changeMonth     = changeMonth;
window.selectDate      = selectDate;
window.clearDateFilter = clearDateFilter;

// ==================== RESET COMPLETO ====================
function resetCompleteState() {
    console.log('🔄 Reseteando estado completo...');
    state.user = null; state.isGuest = false; state.view = 'login';
    state.vacancies = []; state.filteredVacancies = [];
    state.dateFilter = null; state.selectedCategory = null;
    state.editingVacancy = null;
    state.showPassword = false; state.showConfirmPassword = false;
    state.menuOpen = false; state.acceptedTerms = false;
    state.loading = false; state.isRendering = false; state.isLoggingOut = false;
    clearTimeout(_renderTimer); _renderTimer = null;
    resetAuthForm();
    resetJobForm();
    clearAIData();
}

// ==================== CONTADOR DE VISITAS ====================
const COUNTER_TABLE  = 'visit_counter';
const COUNTER_ROW_ID = 1;
const COUNTER_BASE   = 2000;
const SESSION_KEY    = 'emp_leon_visited';

function injectCounterBar() {
    if (document.getElementById('visit-counter-bar')) return;
    const bar = document.createElement('div');
    bar.id = 'visit-counter-bar';
    bar.className = 'visit-counter-bar';
    bar.innerHTML = `
        <span class="visit-counter-icon">👥</span>
        <span class="visit-counter-text">Tu comunidad ha alcanzado</span>
        <span class="visit-counter-dot"></span>
        <span class="visit-counter-number" id="visit-count-display">...</span>
        <span class="visit-counter-text">usuarios</span>`;
    document.body.appendChild(bar);
    document.body.style.paddingBottom = '46px';
}

function alreadyCountedToday() {
    try { const r = localStorage.getItem(SESSION_KEY); if (!r) return false; const { date } = JSON.parse(r); return date === new Date().toISOString().slice(0,10); }
    catch { return false; }
}
function markVisitedToday() {
    try { localStorage.setItem(SESSION_KEY, JSON.stringify({ date: new Date().toISOString().slice(0,10) })); } catch {}
}

async function getCount() {
    try {
        const { data, error } = await supabaseClient.from(COUNTER_TABLE).select('count').eq('id', COUNTER_ROW_ID).single();
        if (error) throw error;
        return Number(data.count) || COUNTER_BASE;
    } catch {
        try { const c = localStorage.getItem('emp_leon_count'); if (c) return Number(c); } catch {}
        return COUNTER_BASE;
    }
}

async function incrementCount(current) {
    const next = current + 1;
    try {
        const { error } = await supabaseClient.from(COUNTER_TABLE).update({ count: next }).eq('id', COUNTER_ROW_ID);
        if (error) throw error;
        return next;
    } catch {
        try { localStorage.setItem('emp_leon_count', String(next)); } catch {}
        return next;
    }
}

function animateCount(from, to, ms) {
    ms = ms || 1400;
    const el = document.getElementById('visit-count-display');
    if (!el) return;
    const t0 = performance.now();
    function frame(now) {
        const p = Math.min((now - t0) / ms, 1);
        const ease = 1 - Math.pow(1 - p, 3);
        el.textContent = Math.round(from + (to - from) * ease).toLocaleString('es-MX');
        if (p < 1) requestAnimationFrame(frame);
    }
    requestAnimationFrame(frame);
}

async function initVisitCounter() {
    injectCounterBar();
    const current = await getCount();
    try { localStorage.setItem('emp_leon_count', String(current)); } catch {}
    let display = current;
    if (!alreadyCountedToday()) { display = await incrementCount(current); markVisitedToday(); }
    animateCount(Math.max(COUNTER_BASE, display - 25), display);
}

function waitAndStart() {
    if (typeof supabaseClient !== 'undefined' && supabaseClient) {
        initVisitCounter().catch(e => console.warn('Counter init error:', e));
    } else { setTimeout(waitAndStart, 200); }
}
window.addEventListener('DOMContentLoaded', waitAndStart);

// ==================== AUTENTICACIÓN ====================
async function handleLogin(e) {
    e.preventDefault();
    if (state.loading) return;
    const email    = state.formData.email?.trim();
    const password = state.formData.password;
    if (!email || !password) { showModal('error', 'Error', 'Correo y contraseña son requeridos'); return; }
    showLoading();
    try {
        const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
        if (error) throw error;
        if (!data?.user) throw new Error('No se recibió información del usuario');
        setTimeout(() => hideLoading(), 5000);
    } catch (error) {
        console.error('❌ Error login:', error);
        showModal('error', 'Credenciales incorrectas', 'Correo o contraseña incorrectos. Por favor valida tu información.');
        hideLoading();
    }
}

async function handleSignup(e) {
    e.preventDefault();
    if (state.loading) return;
    if (state.formData.password !== state.formData.confirmPassword) { showModal('error', 'Error', 'Las contraseñas no coinciden'); return; }
    if (state.formData.password.length < 6) { showModal('error', 'Error', 'La contraseña debe tener al menos 6 caracteres'); return; }
    showLoading();
    try {
        const { data, error } = await supabaseClient.auth.signUp({
            email: state.formData.email.trim().toLowerCase(),
            password: state.formData.password,
            options: { emailRedirectTo: ENDPOINTS.SUPABASE_REDIRECT_URL }
        });
        if (error) {
            if (error.message?.includes('already registered') || error.message?.includes('duplicate') || error.status === 422) {
                hideLoading();
                showModal('error', 'Correo ya registrado', `El correo ${state.formData.email.trim().toLowerCase()} ya tiene una cuenta. Por favor inicia sesión o usa otro correo.`);
                return;
            }
            throw error;
        }
        if (data?.user && Array.isArray(data.user.identities) && data.user.identities.length === 0) {
            hideLoading();
            showModal('error', 'Correo ya registrado', `El correo ${state.formData.email.trim().toLowerCase()} ya tiene una cuenta registrada. Por favor inicia sesión o usa otro correo.`);
            return;
        }
        hideLoading();
        showModal('info', '📧 Revisa tu correo', `Se envió un enlace de confirmación a:\n${state.formData.email.trim().toLowerCase()}\n\nHaz clic en ese enlace para activar tu cuenta y luego inicia sesión normalmente.`);
        state.view = 'login';
        resetAuthForm();
        render();
    } catch (error) {
        console.error('❌ Error signup:', error);
        showModal('error', 'Error de registro', error.message || 'No se pudo crear la cuenta. Intenta de nuevo.');
        hideLoading();
    }
}

function handleForgotPassword() {
    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.innerHTML = `
        <div class="modal-window">
            <div class="modal-header modal-header-info">
                <i class="fas fa-lock" style="color:#667eea;font-size:24px"></i>
                <div class="header-text"><h3>Restablecer contraseña</h3></div>
            </div>
            <div class="modal-body">
                <p style="color:#4b5563;font-size:14px;margin-bottom:16px;line-height:1.6;">Ingresa el correo electrónico con el que te registraste.</p>
                <div style="position:relative;">
                    <input type="email" id="reset-email-input" placeholder="tu@email.com"
                        style="width:100%;padding:12px 16px 12px 40px;border:2px solid #e5e7eb;border-radius:10px;font-size:14px;outline:none;"
                        onfocus="this.style.borderColor='#667eea'" onblur="this.style.borderColor='#e5e7eb'">
                    <i class="fas fa-envelope" style="position:absolute;left:13px;top:50%;transform:translateY(-50%);color:#9ca3af;font-size:14px;pointer-events:none;"></i>
                </div>
                <p id="reset-error-msg" style="display:none;color:#ef4444;font-size:12px;margin-top:8px;"><i class="fas fa-exclamation-circle"></i> Por favor ingresa un correo válido.</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-cancel modal-cancel-reset">Cancelar</button>
                <button class="btn btn-primary modal-send-reset" style="background:linear-gradient(135deg,#667eea,#764ba2);">
                    <i class="fas fa-paper-plane"></i> Enviar enlace
                </button>
            </div>
        </div>`;
    document.getElementById('modal-root').appendChild(modal);
    setTimeout(() => document.getElementById('reset-email-input')?.focus(), 100);

    modal.querySelector('.modal-cancel-reset').onclick = () => modal.remove();
    modal.onclick = (e) => { if (e.target === modal) modal.remove(); };

    const sendBtn = modal.querySelector('.modal-send-reset');
    sendBtn.onclick = async () => {
        const emailInput = document.getElementById('reset-email-input');
        const errorMsg   = document.getElementById('reset-error-msg');
        const email = emailInput?.value?.trim().toLowerCase();
        if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
            if (errorMsg) errorMsg.style.display = 'block';
            if (emailInput) emailInput.style.borderColor = '#ef4444';
            return;
        }
        modal.remove();
        showLoading();
        try {
            const { error } = await supabaseClient.auth.resetPasswordForEmail(email, { redirectTo: ENDPOINTS.SUPABASE_REDIRECT_URL });
            if (error) throw error;
            hideLoading();
            showModal('success', '¡Correo enviado! 📧', `Se envió un enlace para restablecer tu contraseña a:\n${email}\n\nRevisa tu bandeja de entrada y también Spam.`);
        } catch (err) {
            console.error('❌ Error reset password:', err);
            hideLoading();
            showModal('error', 'Error', 'No se pudo enviar el correo. Verifica que la dirección sea correcta.');
        }
    };
    document.getElementById('reset-email-input')?.addEventListener('keydown', (e) => { if (e.key === 'Enter') sendBtn.click(); });
}

function showNewPasswordModal() {
    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.innerHTML = `
        <div class="modal-window">
            <div class="modal-header modal-header-info">
                <i class="fas fa-key" style="color:#667eea;font-size:24px"></i>
                <div class="header-text"><h3>Crear nueva contraseña</h3></div>
            </div>
            <div class="modal-body">
                <p style="color:#4b5563;font-size:14px;margin-bottom:16px;line-height:1.6;">Ingresa tu nueva contraseña (mínimo 6 caracteres).</p>
                <div style="position:relative;margin-bottom:14px;">
                    <input type="password" id="new-password-input" placeholder="Nueva contraseña"
                        style="width:100%;padding:12px 16px 12px 40px;border:2px solid #e5e7eb;border-radius:10px;font-size:14px;outline:none;"
                        onfocus="this.style.borderColor='#667eea'" onblur="this.style.borderColor='#e5e7eb'">
                    <i class="fas fa-lock" style="position:absolute;left:13px;top:50%;transform:translateY(-50%);color:#9ca3af;font-size:14px;pointer-events:none;"></i>
                </div>
                <div style="position:relative;">
                    <input type="password" id="new-password-confirm" placeholder="Confirmar nueva contraseña"
                        style="width:100%;padding:12px 16px 12px 40px;border:2px solid #e5e7eb;border-radius:10px;font-size:14px;outline:none;"
                        onfocus="this.style.borderColor='#667eea'" onblur="this.style.borderColor='#e5e7eb'">
                    <i class="fas fa-lock" style="position:absolute;left:13px;top:50%;transform:translateY(-50%);color:#9ca3af;font-size:14px;pointer-events:none;"></i>
                </div>
                <p id="new-pwd-error-msg" style="display:none;color:#ef4444;font-size:12px;margin-top:8px;">
                    <i class="fas fa-exclamation-circle"></i> <span id="new-pwd-error-text"></span>
                </p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-cancel modal-cancel-new-pwd">Cancelar</button>
                <button class="btn btn-save modal-confirm-new-pwd"><i class="fas fa-check"></i> Aceptar</button>
            </div>
        </div>`;
    document.getElementById('modal-root').appendChild(modal);
    setTimeout(() => document.getElementById('new-password-input')?.focus(), 100);

    modal.querySelector('.modal-cancel-new-pwd').onclick = () => { modal.remove(); resetCompleteState(); render(); showModal('info', 'Cambio cancelado', 'No se actualizó tu contraseña.'); };

    const confirmBtn = modal.querySelector('.modal-confirm-new-pwd');
    confirmBtn.onclick = async () => {
        const pwdInput   = document.getElementById('new-password-input');
        const confirmInp = document.getElementById('new-password-confirm');
        const errorMsg   = document.getElementById('new-pwd-error-msg');
        const errorText  = document.getElementById('new-pwd-error-text');
        const pwd = pwdInput?.value?.trim();
        const conf = confirmInp?.value?.trim();
        if (!pwd || pwd.length < 6) { errorText.textContent = 'La contraseña debe tener al menos 6 caracteres.'; errorMsg.style.display = 'block'; pwdInput.style.borderColor = '#ef4444'; return; }
        if (pwd !== conf) { errorText.textContent = 'Las contraseñas no coinciden.'; errorMsg.style.display = 'block'; confirmInp.style.borderColor = '#ef4444'; return; }
        modal.remove();
        showLoading();
        try {
            const { error } = await supabaseClient.auth.updateUser({ password: pwd });
            if (error) throw error;
            hideLoading();
            resetCompleteState();
            render();
            showModal('success', '¡Contraseña actualizada! 🎉', 'Tu contraseña ha sido cambiada exitosamente. Ahora puedes iniciar sesión.');
        } catch (err) {
            hideLoading();
            console.error('❌ Error actualizando contraseña:', err);
            showModal('error', 'Error', 'No se pudo actualizar la contraseña. Intenta de nuevo.');
            resetCompleteState();
            render();
        }
    };
    document.getElementById('new-password-confirm')?.addEventListener('keydown', (e) => { if (e.key === 'Enter') confirmBtn.click(); });
}

async function handleLogout() {
    if (state.isLoggingOut) return;
    showModal('question-danger', 'Cerrar sesión', '¿Estás seguro de que deseas cerrar sesión?', async () => {
        console.log('🚪 Cerrando sesión...');
        state.isLoggingOut = true;
        resetCompleteState();
        render(true);
        try { await supabaseClient.auth.signOut(); console.log('✅ Sesión cerrada'); }
        catch (error) { console.error('❌ Error logout (no crítico):', error); }
    });
}

async function handleDeleteAccount() {
    showModal('question-danger', 'Eliminar cuenta', '¿ELIMINAR tu cuenta y TODAS tus vacantes? Esta acción no se puede deshacer.', async () => {
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-window">
                <div class="modal-header modal-header-error">
                    <i class="fas fa-exclamation-triangle" style="color:#ef4444"></i>
                    <div class="header-text"><h3>Confirmación final</h3></div>
                </div>
                <div class="modal-body">
                    <p style="margin-bottom:12px">Escribe <strong>ELIMINAR</strong> para confirmar:</p>
                    <input type="text" id="delete-confirm-input" style="width:100%;padding:10px;border:2px solid #e5e7eb;border-radius:6px;font-size:14px" placeholder="ELIMINAR">
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">Cancelar</button>
                    <button class="btn btn-primary" style="background:#ef4444" id="confirm-delete-btn">Eliminar</button>
                </div>
            </div>`;
        document.getElementById('modal-root').appendChild(modal);
        document.getElementById('confirm-delete-btn').onclick = async () => {
            if (document.getElementById('delete-confirm-input').value !== 'ELIMINAR') { showModal('error', 'Error', 'Debes escribir ELIMINAR para confirmar'); return; }
            modal.remove();
            showLoading();
            try {
                const { data: userVacancies } = await supabaseClient.from(ENDPOINTS.TABLES.VACANCIES).select('id').eq('user_id', state.user.id);
                if (userVacancies?.length > 0) {
                    for (const v of userVacancies) await supabaseClient.from(ENDPOINTS.TABLES.VACANCIES).delete().eq('id', v.id);
                }
                if (state.user?.id) localStorage.removeItem('terms_accepted_' + state.user.id);
                showModal('success', '¡Eliminado!', 'Tus vacantes han sido eliminadas');
                setTimeout(() => handleLogout(), 2000);
            } catch (error) {
                console.error('❌ Error delete:', error);
                showModal('error', 'Error', 'No se pudo eliminar la cuenta');
            } finally { hideLoading(); }
        };
    });
}

async function handleGuestAccess() {
    console.log('👤 Acceso como invitado...');
    showLoading();
    try {
        state.isGuest = true;
        state.view = 'categories';
        await loadVacancies();
        console.log('✅ Acceso invitado. Vacantes:', state.vacancies.length);
        hideLoading();
        render();
        showModal('info', '¡Bienvenido!', 'Estás navegando como invitado. Podrás ver todas las vacantes pero no publicar.');
    } catch (error) {
        console.error('❌ Error acceso invitado:', error);
        showModal('error', 'Error', 'No se pudo cargar las vacantes');
        state.isGuest = false;
        state.view = 'login';
        hideLoading();
        render();
    }
}

function handleAcceptTerms() {
    if (!state.acceptedTerms) { showModal('warning', 'Términos requeridos', 'Debes aceptar los términos'); return; }
    if (state.user) localStorage.setItem('terms_accepted_' + state.user.id, 'true');
    state.view = 'categories';
    render();
}

// ==================== VACANTES ====================
async function loadVacancies() {
    console.log('📥 Cargando vacantes...');
    try {
        const { data, error } = await supabaseClient.from(ENDPOINTS.TABLES.VACANCIES).select('*').order('created_at', { ascending: false });
        if (error) throw error;
        state.vacancies = data || [];
        state.filteredVacancies = [...state.vacancies];
        if (state.dateFilter) filterVacanciesByDate();
        console.log('✅ Vacantes cargadas:', state.vacancies.length);
    } catch (error) {
        console.error('❌ Error loading vacancies:', error);
        state.vacancies = []; state.filteredVacancies = [];
    }
}

async function handleImageUpload(e) {
    const file = e.target.files?.[0];
    if (!file) return;
    if (!file.type.startsWith('image/')) { showModal('error', 'Tipo inválido', 'Solo se permiten imágenes (JPG, PNG, WEBP).'); e.target.value = ''; return; }
    if (file.size > 10 * 1024 * 1024) { showModal('error', 'Archivo muy grande', 'La imagen no debe superar 10MB.'); e.target.value = ''; return; }
    try {
        showLoading();
        const compressedBase64 = await compressImage(file, 800, 0.75);
        state.formData.imageBase64 = compressedBase64;
        hideLoading();
        render();
    } catch (error) {
        hideLoading();
        console.error('❌ Error procesando imagen:', error);
        showModal('error', 'Error', 'No se pudo procesar la imagen. Intenta con otra.');
        e.target.value = '';
    }
}

function compressImage(file, maxSize, quality) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onerror = () => reject(new Error('Error leyendo archivo'));
        reader.onload = (ev) => {
            const img = new Image();
            img.onerror = () => reject(new Error('Error cargando imagen'));
            img.onload = () => {
                try {
                    let w = img.width, h = img.height;
                    if (w > maxSize || h > maxSize) {
                        if (w >= h) { h = Math.round((h * maxSize) / w); w = maxSize; }
                        else { w = Math.round((w * maxSize) / h); h = maxSize; }
                    }
                    const canvas = document.createElement('canvas');
                    canvas.width = w; canvas.height = h;
                    canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                    resolve(canvas.toDataURL('image/jpeg', quality));
                } catch (err) { reject(err); }
            };
            img.src = ev.target.result;
        };
        reader.readAsDataURL(file);
    });
}

async function handleSaveVacancy(e) {
    e.preventDefault();
    if (state.loading) return;
    if (!state.user?.id) { showModal('error', 'Sesión requerida', 'Inicia sesión para publicar'); return; }

    if (!state.formData.imageBase64) {
        state.formData.imageBase64 = 'https://raw.githubusercontent.com/Compualextech24/empleosdeleongtoaxel/main/SINFOTO.jpg';
    }

    const missingFields = [];
    if (!state.formData.company?.trim())          missingFields.push('• Nombre de la empresa');
    if (!state.formData.description?.trim())      missingFields.push('• Descripción breve');
    if (!state.formData.publication_date?.trim()) missingFields.push('• Fecha de publicación');
    if (!state.formData.category?.trim())         missingFields.push('• Categoría');
    if (missingFields.length > 0) { showModal('warning', 'Campos requeridos', `Por favor completa los siguientes campos:\n${missingFields.join('\n')}`); return; }

    const dateVal = state.formData.publication_date.trim();
    if (!/^\d{2}\/\d{2}\/\d{4}$/.test(dateVal)) { showModal('warning', 'Formato de fecha incorrecto', 'La fecha debe tener el formato DD/MM/AAAA (ej: 25/07/2025)'); return; }

    state.loading = true;
    showLoading();

    const safetyTimer = setTimeout(() => {
        if (state.loading) {
            console.warn('⚠️ Timeout de seguridad activado');
            hideLoading();
            state.loading = false;
            showModal('error', 'Tiempo agotado', 'La operación tardó demasiado. Verifica tu conexión e intenta de nuevo.');
        }
    }, 20000);

    try {
        const vacancyData = {
            user_id:          state.user.id,
            company:          (state.formData.company?.trim() || 'SIN INFORMACIÓN').toUpperCase(),
            job_title:        state.formData.job_title?.trim()        || 'SIN INFORMACIÓN',
            description:      state.formData.description?.trim()      || 'SIN INFORMACIÓN',
            requirements:     state.formData.requirements?.trim()     || null,
            location:         state.formData.location?.trim()         || null,
            contact_phone:    state.formData.contact_phone?.trim()    || null,
            publication_date: state.formData.publication_date?.trim() || null,
            schedule:         state.formData.schedule?.trim()         || null,
            work_days:        state.formData.work_days?.trim()        || null,
            category:         state.formData.category?.trim()         || null,
            image_base64:     state.formData.imageBase64
        };

        let result;
        if (state.editingVacancy) {
            result = await supabaseClient.from(ENDPOINTS.TABLES.VACANCIES).update(vacancyData).eq('id', state.editingVacancy.id);
        } else {
            result = await supabaseClient.from(ENDPOINTS.TABLES.VACANCIES).insert([vacancyData]);
        }
        if (result.error) throw result.error;

        const wasEditing = !!state.editingVacancy;
        state.editingVacancy = null;
        resetJobForm();
        clearAIData();
        await loadVacancies();
        clearTimeout(safetyTimer);
        hideLoading();
        state.view = 'dashboard';
        render();
        showModal('success', '¡Éxito!', wasEditing ? 'Vacante actualizada ✅' : 'Vacante publicada ✅');
    } catch (error) {
        clearTimeout(safetyTimer);
        console.error('❌ Error saving:', error);
        hideLoading();
        showModal('error', 'Error al guardar', error.message || 'No se pudo guardar la vacante. Intenta de nuevo.');
    } finally {
        state.loading = false;
    }
}

async function handleDeleteVacancy(vacancyId) {
    const vacancy = state.vacancies.find(v => v.id === vacancyId);
    if (!vacancy) return;
    showModal('question', 'Eliminar vacante', `¿Eliminar vacante de ${vacancy.company}?`, async () => {
        showLoading();
        try {
            const { error } = await supabaseClient.from(ENDPOINTS.TABLES.VACANCIES).delete().eq('id', vacancy.id);
            if (error) throw error;
            await loadVacancies();
            render();
            showModal('success', '¡Eliminado!', 'Vacante eliminada');
        } catch (error) {
            console.error('❌ Error delete vacancy:', error);
            showModal('error', 'Error', 'No se pudo eliminar');
        } finally { hideLoading(); }
    });
}

function handleEditVacancy(vacancyId) {
    const vacancy = state.vacancies.find(v => v.id === vacancyId);
    if (!vacancy) return;
    state.editingVacancy = vacancy;
    state.formData = {
        company:          cleanValue(vacancy.company),
        job_title:        cleanValue(vacancy.job_title),
        description:      cleanValue(vacancy.description),
        requirements:     cleanValue(vacancy.requirements) || 'Disponibilidad y actitud de trabajar',
        location:         cleanValue(vacancy.location),
        contact_phone:    cleanValue(vacancy.contact_phone),
        publication_date: cleanValue(vacancy.publication_date),
        schedule:         cleanValue(vacancy.schedule),
        work_days:        cleanValue(vacancy.work_days),
        category:         cleanValue(vacancy.category),
        imageBase64:      cleanValue(vacancy.image_base64),
        email: '', password: '', confirmPassword: ''
    };
    clearAIData();
    state.view = 'form';
    render();
}

// ==================== IA ====================
const AI_ADMIN_EMAILS = ['compualextech24@gmail.com', 'flavioalejandrov24@gmail.com'];
function isAIAdmin() { return state.user?.email ? AI_ADMIN_EMAILS.includes(state.user.email.toLowerCase().trim()) : false; }

function showAIAccessDeniedModal() {
    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.innerHTML = `
        <div class="modal-window">
            <div class="modal-header modal-header-info">
                <i class="fas fa-robot" style="color:#3b82f6;font-size:28px"></i>
                <div class="header-text"><h3>Función de Autofill con IA</h3></div>
            </div>
            <div class="modal-body">
                <h4 style="font-weight:700;font-size:15px;margin-bottom:10px;">¿Qué es el Autofill IA?</h4>
                <p style="color:#4b5563;font-size:14px;line-height:1.7;margin-bottom:14px;">
                    Esta función te permite subir una <strong>imagen</strong> o escribir el texto de una oferta de empleo,
                    y la inteligencia artificial extrae automáticamente todos los datos para llenar el formulario.
                </p>
                <div style="background:#f0f9ff;border:1px solid #bae6fd;border-radius:10px;padding:12px 14px;display:flex;gap:10px;align-items:flex-start;">
                    <i class="fas fa-shield-alt" style="color:#0284c7;margin-top:2px;flex-shrink:0;"></i>
                    <p style="color:#0c4a6e;font-size:13px;line-height:1.6;margin:0;">
                        Actualmente esta función está disponible <strong>solo para administradores</strong> del portal.
                        Si deseas acceso o quieres una app similar para tu negocio, contáctanos.
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary modal-ok" style="width:100%"><i class="fas fa-check mr-1"></i> Entendido</button>
            </div>
        </div>`;
    document.getElementById('modal-root').appendChild(modal);
    modal.querySelector('.modal-ok').onclick = () => modal.remove();
    modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
}

async function sendAIMessage() {
    if (!isAIAdmin()) { showAIAccessDeniedModal(); return; }
    const input = document.getElementById('ai-chat-input');
    const message = input?.value.trim();
    if (!message && !state.aiImage) { showModal('info', 'Mensaje vacío', 'Escribe algo o sube una imagen'); return; }

    if (message) state.aiMessages.push({ role: 'user', content: message });

    _updateAIChatMessages(true);
    state.aiLoading = true;

    try {
        const requestData = { text: message || '' };
        if (state.aiImage) {
            const reader = new FileReader();
            const base64 = await new Promise((resolve, reject) => {
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = () => reject(new Error('Error al leer imagen'));
                reader.readAsDataURL(state.aiImage);
            });
            requestData.image = base64;
        }
        const response = await fetch(EndpointHelpers.getAIExtractUrl(), {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${ENDPOINTS.SUPABASE_ANON_KEY}` },
            body: JSON.stringify(requestData)
        });
        if (!response.ok) throw new Error(`Error ${response.status}`);
        const data = await response.json();
        state.aiMessages.push({ role: 'bot', content: data.message || 'Datos procesados. Presiona START para llenar el formulario. ✅' });
        if (data.formData) state.aiExtractedData = data.formData;
    } catch (error) {
        console.error('❌ Error IA:', error);
        state.aiMessages.push({ role: 'bot', content: `Error: ${error.message}. Intenta nuevamente. 🔄` });
    } finally {
        state.aiLoading = false;
        if (input) input.value = '';
        state.aiImage = null;
        state.aiImagePreview = null;
        render();
        setTimeout(() => {
            const msgs = document.querySelector('.ai-chat-messages');
            if (msgs) msgs.scrollTop = msgs.scrollHeight;
        }, 100);
    }
}

function _updateAIChatMessages(showSpinner) {
    const container = document.querySelector('.ai-chat-messages');
    if (!container) return;
    container.innerHTML = state.aiMessages.map(m => `
        <div class="ai-message ${m.role}">${escapeHtml(m.content)}</div>`).join('') +
        (showSpinner ? '<div class="ai-message bot"><span class="ai-loading"></span> Procesando...</div>' : '');
    container.scrollTop = container.scrollHeight;
}

function toggleAIChat() {
    if (!isAIAdmin()) { showAIAccessDeniedModal(); return; }
    state.aiChatOpen = !state.aiChatOpen;
    if (state.aiChatOpen && state.aiMessages.length === 0) {
        state.aiMessages = [{ role: 'bot', content: '¡Hola! Envíame una imagen o describe la vacante y te ayudo a llenar el formulario. 📋✨' }];
    }
    render();
}

function startAutofill() {
    if (!state.aiExtractedData) { showModal('info', 'Sin datos', 'Primero envía información para procesar'); return; }
    const data = state.aiExtractedData;
    if (data.company)           state.formData.company           = data.company;
    if (data.job_title)         state.formData.job_title         = data.job_title;
    if (data.description)       state.formData.description       = data.description;
    if (data.requirements)      state.formData.requirements      = data.requirements;
    if (data.location)          state.formData.location          = data.location;
    if (data.contact_phone)     state.formData.contact_phone     = data.contact_phone;
    if (data.publication_date)  state.formData.publication_date  = data.publication_date;
    if (data.schedule)          state.formData.schedule          = data.schedule;
    if (data.work_days)         state.formData.work_days         = data.work_days;
    if (data.category)          state.formData.category          = data.category;
    state.aiChatOpen = false;
    state.aiMessages = [];
    state.aiExtractedData = null;
    render();
    showModal('success', '¡Formulario rellenado!', 'Revisa y ajusta antes de guardar ✨');
}

function handleAIImageUpload(event) {
    const file = event.target.files?.[0];
    if (!file) return;
    if (file.size > 10 * 1024 * 1024) { showModal('error', 'Archivo Grande', 'Máximo 10MB'); event.target.value = ''; return; }
    state.aiImage = file;
    const reader = new FileReader();
    reader.onload = (e) => { state.aiImagePreview = e.target.result; render(); };
    reader.readAsDataURL(file);
}

function removeAIImage() { state.aiImage = null; state.aiImagePreview = null; render(); }

function clearAIData() {
    state.aiChatOpen = false; state.aiMessages = []; state.aiLoading = false;
    state.aiImage = null; state.aiImagePreview = null; state.aiExtractedData = null; state.chatMinimized = false;
}

// ==================== FORMULARIO ====================
function cleanForm() {
    showModal('question', 'Limpiar formulario', '¿Limpiar todos los campos?', () => { resetJobForm(); clearAIData(); render(); });
}

function cancelForm() {
    showModal('question-danger', 'Cancelar', '¿Cancelar? Los cambios se perderán', () => {
        state.editingVacancy = null;
        state.view = 'dashboard';
        resetJobForm();
        clearAIData();
        render();
    });
}

function resetAuthForm() { state.formData.email = ''; state.formData.password = ''; state.formData.confirmPassword = ''; }

function resetJobForm() {
    state.formData.company = ''; state.formData.job_title = ''; state.formData.description = '';
    state.formData.requirements = 'Disponibilidad y actitud de trabajar';
    state.formData.location = ''; state.formData.contact_phone = '';
    state.formData.publication_date = ''; state.formData.schedule = '';
    state.formData.work_days = ''; state.formData.category = ''; state.formData.imageBase64 = '';
}

// ==================== DESCARGA DE CARD COMO IMAGEN ====================
function _addWatermark(canvas) {
    const ctx  = canvas.getContext('2d');
    const text = '⚡ Axellabstech';
    const pad  = 18;
    const fontSize = Math.max(18, Math.round(canvas.width * 0.045));
    ctx.font      = `600 ${fontSize}px -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif`;
    ctx.textAlign = 'left';
    const textW = ctx.measureText(text).width;
    const textH = fontSize;
    const rx = pad - 6, ry = canvas.height - textH - pad - 4;
    const rw = textW + 24, rh = textH + 14;
    ctx.save();
    ctx.globalAlpha = 0.38;
    ctx.fillStyle   = '#1e1b4b';
    ctx.beginPath();
    ctx.roundRect(rx, ry, rw, rh, 8);
    ctx.fill();
    ctx.globalAlpha = 0.70;
    ctx.fillStyle   = '#e9d5ff';
    ctx.fillText(text, pad, canvas.height - pad);
    ctx.restore();
}

function _triggerBlobDownload(canvas, filename) {
    return new Promise((resolve, reject) => {
        canvas.toBlob((blob) => {
            if (!blob) { reject(new Error('No se pudo generar el blob')); return; }
            const blobUrl = URL.createObjectURL(blob);
            const link    = document.createElement('a');
            link.href     = blobUrl;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            setTimeout(() => URL.revokeObjectURL(blobUrl), 3000);
            resolve();
        }, 'image/png');
    });
}

function _showDownloadConfirm(canvas, filename, onConfirm) {
    const preview = canvas.toDataURL('image/png');
    const modal   = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.innerHTML = `
        <div class="modal-window" style="max-width:360px;">
            <div class="modal-header modal-header-info">
                <i class="fas fa-image" style="color:#667eea;font-size:22px"></i>
                <div class="header-text">
                    <h3>¿Guardar esta imagen?</h3>
                </div>
            </div>
            <div class="modal-body" style="padding:16px 20px;">
                <img src="${preview}"
                     style="width:100%;border-radius:10px;box-shadow:0 4px 14px rgba(0,0,0,0.15);display:block;">
            </div>
            <div class="modal-footer" style="gap:10px;">
                <button class="btn btn-cancel" id="dl-cancel" style="flex:1;">No</button>
                <button class="btn btn-save"   id="dl-confirm" style="flex:1;"><i class="fas fa-download"></i> Sí, guardar</button>
            </div>
        </div>`;
    document.getElementById('modal-root').appendChild(modal);
    modal.querySelector('#dl-cancel').onclick  = () => modal.remove();
    modal.querySelector('#dl-confirm').onclick = () => { modal.remove(); onConfirm(); };
    modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
}

async function downloadCard(btn, vacancyId) {
    const card = btn.closest('.vacancy-card');
    if (!card) return;

    btn.classList.add('downloading');
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

    const originalOverflow = card.style.overflow;
    const originalHeight   = card.style.height;
    const originalMaxH     = card.style.maxHeight;

    card.style.overflow  = 'visible';
    card.style.height    = 'auto';
    card.style.maxHeight = 'none';

    const realHeight = card.scrollHeight;

    let canvas;
    try {
        canvas = await html2canvas(card, {
            useCORS:        true,
            allowTaint:     true,
            backgroundColor: '#ffffff',
            scale:           2,
            logging:         false,
            height:          realHeight,
            windowHeight:    realHeight + 200,
            scrollY:         -window.scrollY,
            scrollX:         0,
            ignoreElements: (el) => el.hasAttribute('data-html2canvas-ignore')
        });
        _addWatermark(canvas);
    } catch (err) {
        console.error('❌ Error generando imagen:', err);
        showModal('error', 'Error', 'No se pudo generar la imagen. Intenta de nuevo.');
        btn.classList.remove('downloading');
        btn.innerHTML = '<i class="fas fa-download"></i>';
        card.style.overflow  = originalOverflow;
        card.style.height    = originalHeight;
        card.style.maxHeight = originalMaxH;
        return;
    }

    card.style.overflow  = originalOverflow;
    card.style.height    = originalHeight;
    card.style.maxHeight = originalMaxH;
    btn.classList.remove('downloading');
    btn.innerHTML = '<i class="fas fa-download"></i>';

    const vacancy  = state.vacancies.find(v => v.id === vacancyId);
    const empresa  = vacancy?.company
        ? vacancy.company.replace(/[^a-zA-Z0-9]/g, '_').toLowerCase()
        : 'vacante';
    const filename = `vacante_${empresa}_empleos_leon.png`;

    _showDownloadConfirm(canvas, filename, async () => {
        try {
            await _triggerBlobDownload(canvas, filename);
        } catch (err) {
            console.warn('Blob download falló, abriendo en nueva pestaña:', err);
            const dataUrl = canvas.toDataURL('image/png');
            const newTab  = window.open();
            if (newTab) {
                newTab.document.write(`<!DOCTYPE html><html><head>
                    <meta name="viewport" content="width=device-width,initial-scale=1">
                    <title>${filename}</title>
                    <style>*{margin:0;padding:0;box-sizing:border-box}body{background:#111;display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;gap:16px;padding:20px}img{max-width:100%;border-radius:12px;box-shadow:0 8px 32px rgba(0,0,0,.5)}p{color:rgba(255,255,255,.8);font-family:sans-serif;font-size:15px;text-align:center;line-height:1.7}strong{color:#a78bfa}</style>
                </head><body>
                    <img src="${dataUrl}" alt="${filename}">
                    <p>📱 <strong>Mantén presionada la imagen</strong><br>y elige "Guardar imagen"</p>
                </body></html>`);
                newTab.document.close();
            }
        }
    });
}

// ==================== RENDER — VISTAS ====================
function renderLogin() {
    return `
    <div class="min-h-screen flex items-center justify-center p-4">
        <a href="https://axeltechnology24-cloud.github.io/ecosistematodoleongto/" class="back-btn-fixed" title="Volver al inicio">
            <i class="fas fa-arrow-left"></i>
        </a>
        <div class="bg-white rounded-3xl shadow-2xl overflow-hidden max-w-md w-full fade-in">
            <div class="login-header-wrapper">
                <div class="login-logo-wrap">
                    <img src="https://raw.githubusercontent.com/Compualextech24/empleosdeleongtoaxel/main/logosempleosleonaxel.png"
                         alt="Empleos León GTO" class="login-logo-img"
                         onerror="this.style.display='none';this.nextElementSibling.style.display='block'">
                    <div style="display:none;padding:32px 0 8px;" class="text-6xl">💼</div>
                </div>
                <div class="login-text-wrap">
                    <h1 class="text-3xl font-black mb-2">Empleos León GTO</h1>
                    <p style="color:rgba(233,213,255,0.9);font-size:0.875rem;font-weight:600;letter-spacing:0.05em;">Axellabs Created</p>
                </div>
            </div>
            <form id="login-form" class="p-8 space-y-6">
                <div class="input-group">
                    <label>Correo Electrónico</label>
                    <input type="email" id="email" required placeholder="tu@email.com" value="${escapeHtml(state.formData.email)}">
                </div>
                <div class="input-group">
                    <label>Contraseña</label>
                    <input type="${state.showPassword ? 'text' : 'password'}" id="password" required placeholder="••••••••" value="${escapeHtml(state.formData.password)}">
                    <span class="input-icon" id="toggle-pwd"><i class="fas ${state.showPassword ? 'fa-eye-slash' : 'fa-eye'}"></i></span>
                </div>
                <div class="login-btn-row">
                    <button type="submit" class="btn btn-primary login-btn-main" ${state.loading ? 'disabled' : ''}>
                        ${state.loading ? '<i class="fas fa-spinner fa-spin"></i> Iniciando...' : '<i class="fas fa-sign-in-alt"></i> Iniciar Sesión'}
                    </button>
                    <button type="button" id="go-signup" class="btn login-btn-register">
                        <i class="fas fa-user-plus"></i> Registrarse
                    </button>
                </div>
                <div class="text-center space-y-3">
                    <div class="text-sm text-gray-500">
                        ¿Olvidaste tu contraseña?
                        <button type="button" id="forgot-password-btn" class="login-forgot-link">Restablecer</button>
                    </div>
                    <div class="flex items-center justify-center">
                        <button type="button" id="guest-btn" class="guest-access-link">
                            <span class="hand-icon">👉</span>
                            <span>Continuar como invitado</span>
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>`;
}

function renderSignup() {
    return `
    <div class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl overflow-hidden max-w-md w-full fade-in">
            <div class="signup-header-purple">
                <button type="button" id="signup-back-btn" class="back-btn-inheader" title="Volver al login">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <div class="signup-header-content">
                    <div class="text-6xl mb-4">📝</div>
                    <h1 class="text-3xl font-black mb-2">Crear Cuenta</h1>
                    <p class="text-purple-200">Únete al portal</p>
                </div>
            </div>
            <form id="signup-form" class="p-8 space-y-6">
                <div class="input-group">
                    <label>Correo</label>
                    <input type="email" id="email" required placeholder="tu@email.com" value="${escapeHtml(state.formData.email)}">
                </div>
                <div class="input-group">
                    <label>Contraseña</label>
                    <input type="${state.showPassword ? 'text' : 'password'}" id="password" required placeholder="Mínimo 6 caracteres" value="${escapeHtml(state.formData.password)}">
                    <span class="input-icon" id="toggle-pwd"><i class="fas ${state.showPassword ? 'fa-eye-slash' : 'fa-eye'}"></i></span>
                </div>
                <div class="input-group">
                    <label>Confirmar Contraseña</label>
                    <input type="${state.showConfirmPassword ? 'text' : 'password'}" id="confirm-password" required placeholder="Repite tu contraseña" value="${escapeHtml(state.formData.confirmPassword)}">
                    <span class="input-icon" id="toggle-confirm-pwd"><i class="fas ${state.showConfirmPassword ? 'fa-eye-slash' : 'fa-eye'}"></i></span>
                </div>
                <div class="login-btn-row">
                    <button type="submit" class="btn btn-primary login-btn-main" ${state.loading ? 'disabled' : ''}>
                        ${state.loading ? '<i class="fas fa-spinner fa-spin"></i> Creando...' : '<i class="fas fa-user-plus"></i> Crear'}
                    </button>
                    <button type="button" id="signup-cancel-btn" class="btn login-btn-cancel">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                </div>
                <div class="text-center text-sm">
                    ¿Ya tienes cuenta?
                    <button type="button" id="go-login" class="text-purple-600 hover:underline font-semibold">Inicia Sesión</button>
                </div>
            </form>
        </div>
    </div>`;
}

function renderTerms() {
    return `
    <div class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl overflow-hidden max-w-2xl w-full fade-in">
            <div class="bg-gradient-to-br from-purple-600 to-purple-800 p-8 text-white">
                <h2 class="text-3xl font-black mb-2">Aviso Importante</h2>
                <p class="text-purple-200">Lee con atención antes de continuar</p>
            </div>
            <div class="p-8 space-y-6 max-h-96 overflow-y-auto">
                <div class="space-y-5 text-gray-700 text-sm leading-relaxed">
                    <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded-r-xl">
                        <p class="font-bold text-yellow-800 mb-1"><i class="fas fa-exclamation-triangle mr-1"></i> Aviso de Responsabilidad</p>
                        <p class="text-yellow-700"><strong>Empleos León GTO</strong> es una plataforma comunitaria de acceso libre. <strong>No somos una agencia de empleo ni cobramos por ningún servicio.</strong></p>
                    </div>
                    <h3 class="font-bold text-base text-gray-800">1. Carácter informativo del portal</h3>
                    <p>Las vacantes son aportadas directamente por los usuarios de forma voluntaria. El portal actúa como un tablón de avisos digital. <strong>No verificamos ni garantizamos la veracidad de ninguna oferta publicada.</strong></p>
                    <h3 class="font-bold text-base text-gray-800">2. Recomendaciones de seguridad</h3>
                    <p>Antes de acudir a cualquier entrevista, te recomendamos:</p>
                    <ul class="list-disc pl-5 space-y-1 text-gray-600">
                        <li>Verificar la existencia y reputación de la empresa (Google Maps, redes sociales, IMSS, SAT).</li>
                        <li>Confirmar la dirección antes de presentarte.</li>
                        <li>Desconfiar de ofertas que soliciten <strong>depósitos de dinero o pagos previos</strong>.</li>
                        <li>No entregar documentos originales sin verificar previamente.</li>
                        <li>Informar a un familiar sobre la cita antes de asistir.</li>
                    </ul>
                    <h3 class="font-bold text-base text-gray-800">3. Responsabilidad del publicador</h3>
                    <p>Quien publica una vacante es <strong>legalmente responsable</strong> de su veracidad y legalidad. Queda prohibido publicar ofertas falsas, engañosas o con fines ilícitos.</p>
                    <h3 class="font-bold text-base text-gray-800">4. Exención de responsabilidad</h3>
                    <p><strong>Empleos León GTO</strong> y sus administradores no se hacen responsables por pérdidas o daños derivados del uso de la información publicada.</p>
                    <div class="bg-blue-50 border border-blue-200 rounded-xl p-4">
                        <p class="text-blue-800 text-xs"><i class="fas fa-info-circle mr-1"></i> Si detectas una publicación sospechosa, repórtala a los administradores del portal.</p>
                    </div>
                </div>
                <div class="flex items-center gap-3 bg-purple-50 p-4 rounded-xl border border-purple-200">
                    <input type="checkbox" id="accept-terms" ${state.acceptedTerms ? 'checked' : ''} class="w-5 h-5 accent-purple-600">
                    <label for="accept-terms" class="text-sm font-semibold cursor-pointer text-gray-700">He leído y acepto los términos de uso de esta plataforma.</label>
                </div>
            </div>
            <div class="p-8 pt-0">
                <button id="accept-btn" class="btn btn-primary w-full" ${!state.acceptedTerms ? 'disabled' : ''}>
                    <i class="fas fa-check"></i> Continuar al Portal
                </button>
            </div>
        </div>
    </div>`;
}

function renderCategories() {
    const CATEGORIES = [
        { name: 'Todas',                     icon: 'fa-th-list',        color: '#7c3aed', color2: '#a78bfa' },
        { name: 'Fábricas y Calzado',        icon: 'fa-industry',       color: '#b45309', color2: '#d97706' },
        { name: 'Tiendas y Ventas',          icon: 'fa-shopping-cart',  color: '#be185d', color2: '#ec4899' },
        { name: 'Hospitales y Salud',        icon: 'fa-heartbeat',      color: '#b91c1c', color2: '#ef4444' },
        { name: 'Hoteles y Restaurantes',    icon: 'fa-utensils',       color: '#c2410c', color2: '#f97316' },
        { name: 'Bodegas y Transporte',      icon: 'fa-truck',          color: '#a16207', color2: '#eab308' },
        { name: 'Oficinas y Administración', icon: 'fa-building',       color: '#1d4ed8', color2: '#3b82f6' },
        { name: 'Obra y Construcción',       icon: 'fa-hard-hat',       color: '#57534e', color2: '#78716c' },
        { name: 'Escuelas y Clases',         icon: 'fa-graduation-cap', color: '#065f46', color2: '#10b981' },
        { name: 'Sistemas y Computación',    icon: 'fa-laptop-code',    color: '#0e7490', color2: '#06b6d4' },
        { name: 'Leyes y Consultas',         icon: 'fa-balance-scale',  color: '#4338ca', color2: '#6366f1' },
        { name: 'Bancos y Contabilidad',     icon: 'fa-coins',          color: '#3f6212', color2: '#84cc16' },
        { name: 'Mantenimiento y Limpieza',  icon: 'fa-broom',          color: '#0f766e', color2: '#14b8a6' },
        { name: 'Otros',                     icon: 'fa-ellipsis-h',     color: '#0369a1', color2: '#38bdf8' },
    ];
    const totalVacancies = state.vacancies.length;

    return `
    <div class="categories-screen-bg">
        <header class="bg-white shadow-lg sticky top-0 z-50 top-header">
            <div class="max-w-7xl mx-auto px-4 py-4">
                <div class="flex justify-between items-center">
                    <div class="header-title-block">
                        <h1 class="text-2xl font-black">Empleos León GTO</h1>
                        <p class="text-sm">${totalVacancies} vacante${totalVacancies !== 1 ? 's' : ''} disponible${totalVacancies !== 1 ? 's' : ''}</p>
                    </div>
                    <div class="flex items-center gap-2">
                        ${state.isGuest ? `
                            <span class="guest-badge" style="font-size:11px;padding:5px 9px;"><i class="fas fa-user"></i> Invitado</span>
                            <button id="go-login" class="btn btn-outline" style="padding:7px 10px;font-size:12px;"><i class="fas fa-sign-in-alt"></i> Sesión</button>
                        ` : state.user ? `
                            <button id="new-vacancy" class="btn btn-new-vacancy" style="padding:7px 11px;font-size:12px;"><i class="fas fa-plus"></i><span class="btn-nueva-text"> Nueva</span></button>
                            <button id="user-menu" class="btn btn-secondary" style="padding:7px 10px;font-size:12px;width:36px;height:36px;"><i class="fas fa-user"></i></button>
                            ${state.menuOpen ? `
                                <div style="position:fixed;top:70px;right:16px;z-index:9999" class="w-56 bg-white rounded-xl shadow-2xl py-2">
                                    <div class="px-4 py-2 border-b user-session-badge">
                                        <p class="session-label">Sesión activa</p>
                                        <p class="session-email truncate" title="${escapeHtml(state.user.email)}">${escapeHtml(state.user.email)}</p>
                                    </div>
                                    <button id="logout" class="w-full text-left px-4 py-2 hover:bg-gray-100 flex items-center gap-2"><i class="fas fa-sign-out-alt"></i> Cerrar Sesión</button>
                                    <button id="delete-account" class="w-full text-left px-4 py-2 hover:bg-red-50 text-red-600 flex items-center gap-2"><i class="fas fa-trash"></i> Eliminar Cuenta</button>
                                </div>
                            ` : ''}
                        ` : `
                            <button id="go-login" class="btn btn-outline" style="padding:7px 10px;font-size:12px;"><i class="fas fa-sign-in-alt"></i> Iniciar Sesión</button>
                        `}
                    </div>
                </div>
            </div>
        </header>
        <div class="quick-action-bar">
            <span class="quick-action-hand">👉</span>
            <button id="quick-terms-btn" class="quick-btn quick-btn-red quick-btn-wide"><i class="fas fa-file-alt"></i> Términos</button>
            <button id="quick-vacancy-btn" class="quick-btn quick-btn-blue quick-btn-wide"><i class="fas fa-plus"></i> Publicar Vacante</button>
        </div>
        <main class="max-w-5xl mx-auto px-4 pt-6 pb-10" style="background:#fff;">
            <div class="text-center mb-5 fade-in">
                <h2 class="cat-screen-title">Selecciona una opción</h2>
            </div>
            <div class="categories-grid fade-in">
                ${CATEGORIES.map(cat => {
                    const isAll = cat.name === 'Todas';
                    const count = isAll ? totalVacancies : state.vacancies.filter(v => v.category === cat.name).length;
                    const countLabel = isAll ? `${count} vacante${count !== 1 ? 's' : ''} totales` : `${count} vacante${count !== 1 ? 's' : ''}`;
                    return `
                    <button class="category-card-v2 ${isAll ? 'cat-all' : ''}"
                        data-category="${isAll ? '' : escapeHtml(cat.name)}"
                        data-is-all="${isAll}"
                        style="--cat-c1:${cat.color};--cat-c2:${cat.color2}">
                        <div class="cat-v2-icon-wrap">
                            <i class="fas ${cat.icon}"></i>
                        </div>
                        <div class="cat-v2-info">
                            <span class="cat-v2-name">${escapeHtml(cat.name)}</span>
                            <span class="cat-v2-count">${countLabel}</span>
                        </div>
                        <i class="fas fa-chevron-right cat-v2-arrow"></i>
                    </button>`;
                }).join('')}
            </div>
            <div class="app-footer fade-in">
                <span class="app-footer-inner">✨ Created by <strong>Axellabstech</strong> &nbsp;|&nbsp; Empleos León GTO &nbsp;|&nbsp; ✨ Created by <strong>Axellabstech</strong> &nbsp;|&nbsp; Empleos León GTO</span>
            </div>
        </main>
    </div>`;
}

function renderDashboard() {
    const baseVacancies = state.selectedCategory
        ? state.vacancies.filter(v => v.category === state.selectedCategory)
        : state.vacancies;
    const displayVacancies = state.dateFilter
        ? (() => {
            const filterDate = state.dateFilter.toLocaleDateString('es-MX');
            return baseVacancies.filter(v => v.created_at && new Date(v.created_at).toLocaleDateString('es-MX') === filterDate);
          })()
        : baseVacancies;

    const userVacancies  = state.user ? displayVacancies.filter(v => v.user_id === state.user.id) : [];
    const otherVacancies = state.user ? displayVacancies.filter(v => v.user_id !== state.user.id) : displayVacancies;

    return `
    <div class="min-h-screen">
        <header class="bg-white shadow-lg sticky top-0 z-50 top-header">
            <div class="max-w-7xl mx-auto px-4 py-4">
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-3">
                        <button id="back-categories" class="btn-back" title="Volver a categorías"><i class="fas fa-chevron-left"></i></button>
                        <div class="header-title-block">
                            <h1 class="text-xl font-black">${state.selectedCategory ? escapeHtml(state.selectedCategory) : 'Todas las Vacantes'}</h1>
                            <p class="text-sm">${displayVacancies.length} vacante${displayVacancies.length !== 1 ? 's' : ''} ${state.dateFilter ? 'filtradas' : 'disponibles'}</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        ${state.isGuest ? `
                            <span class="guest-badge" style="font-size:11px;padding:5px 9px;"><i class="fas fa-user"></i> Invitado</span>
                            <button id="go-login" class="btn btn-outline" style="padding:7px 10px;font-size:12px;">Sesión</button>
                        ` : state.user ? `
                            <button id="new-vacancy" class="btn btn-new-vacancy" style="padding:7px 11px;font-size:12px;"><i class="fas fa-plus"></i><span class="btn-nueva-text"> Nueva</span></button>
                            <button id="calendar-btn" class="btn btn-calendar ${state.dateFilter ? 'btn-calendar-active' : ''}" style="padding:7px 10px;font-size:12px;"><i class="fas fa-calendar-alt"></i>${state.dateFilter ? ' ●' : ''}</button>
                            <button id="user-menu" class="btn btn-secondary" style="padding:7px 10px;font-size:12px;width:36px;height:36px;"><i class="fas fa-user"></i></button>
                            ${state.menuOpen ? `
                                <div style="position:fixed;top:70px;right:16px;z-index:9999" class="w-56 bg-white rounded-xl shadow-2xl py-2">
                                    <div class="px-4 py-2 border-b user-session-badge">
                                        <p class="session-label">Sesión activa</p>
                                        <p class="session-email truncate" title="${escapeHtml(state.user.email)}">${escapeHtml(state.user.email)}</p>
                                    </div>
                                    <button id="logout" class="w-full text-left px-4 py-2 hover:bg-gray-100 flex items-center gap-2"><i class="fas fa-sign-out-alt"></i> Cerrar Sesión</button>
                                    <button id="delete-account" class="w-full text-left px-4 py-2 hover:bg-red-50 text-red-600 flex items-center gap-2"><i class="fas fa-trash"></i> Eliminar Cuenta</button>
                                </div>
                            ` : ''}
                        ` : `<button id="go-login" class="btn btn-outline" style="padding:7px 10px;font-size:12px;">Iniciar Sesión</button>`}
                    </div>
                </div>
            </div>
        </header>
        <main class="max-w-7xl mx-auto px-4 py-8">
            ${userVacancies.length > 0 ? `
                <section class="mb-8">
                    <h2 class="text-2xl font-black mb-6 dashboard-section-title"><i class="fas fa-briefcase text-purple-600"></i> Mis Vacantes</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        ${userVacancies.map(v => renderVacancyCard(v, true)).join('')}
                    </div>
                </section>
            ` : ''}
            <section>
                <h2 class="text-2xl font-black mb-6 dashboard-section-title">
                    <i class="fas fa-search text-purple-600"></i> ${state.user ? 'Otras Vacantes' : 'Vacantes Disponibles'}
                </h2>
                ${baseVacancies.length === 0 ? `
                    <div class="text-center py-12">
                        <div class="text-6xl mb-4">📭</div>
                        <h3 class="text-xl font-bold text-white">No hay vacantes en esta categoría</h3>
                        ${state.isGuest ? `
                            <p class="text-gray-300 mt-2">Regístrate para publicar la primera vacante</p>
                            <button id="go-signup-from-empty" class="btn btn-primary mt-4"><i class="fas fa-user-plus"></i> Crear Cuenta</button>
                        ` : ''}
                    </div>
                ` : displayVacancies.length === 0 && state.dateFilter ? `
                    <div class="text-center py-12">
                        <div class="text-6xl mb-4">🔍</div>
                        <h3 class="text-xl font-bold text-white">No hay vacantes para esa fecha</h3>
                        <button onclick="clearDateFilter()" class="btn btn-cancel mt-4"><i class="fas fa-times mr-1"></i> Quitar Filtro</button>
                    </div>
                ` : otherVacancies.length === 0 && !state.isGuest ? `
                    <div class="text-center py-12">
                        <div class="text-6xl mb-4">🎉</div>
                        <h3 class="text-xl font-bold text-white">¡Eres el primero! Solo tú has publicado en esta categoría</h3>
                    </div>
                ` : `
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        ${otherVacancies.map(v => renderVacancyCard(v, false)).join('')}
                    </div>
                `}
            </section>
            <div class="app-footer fade-in">
                <span class="app-footer-inner">✨ Created by <strong>Axellabstech</strong> &nbsp;|&nbsp; Empleos León GTO &nbsp;|&nbsp; ✨ Created by <strong>Axellabstech</strong> &nbsp;|&nbsp; Empleos León GTO</span>
            </div>
        </main>
    </div>`;
}

// ==================== FIX UBICACIÓN: parte dirección en calle + colonia ====================
function splitLocation(loc) {
    if (!loc) return { street: '', colony: '' };
    // Separa por coma: "Calle Xyz 123, Col. Centro, León" → street = "Calle Xyz 123", colony = "Col. Centro, León"
    const commaIdx = loc.indexOf(',');
    if (commaIdx === -1) return { street: loc, colony: '' };
    return {
        street: loc.slice(0, commaIdx).trim(),
        colony: loc.slice(commaIdx + 1).trim()
    };
}

function renderVacancyCard(vacancy, isOwner) {
    const reqLines = vacancy.requirements
        ? vacancy.requirements.split('\n').map(l => l.trim()).filter(l => l.length > 0 && l !== 'NULL' && l !== 'null')
        : [];

    const desc = cleanValue(vacancy.description);
    const hasDesc = desc.length > 0;
    const hasReqs = reqLines.length > 0 && !(reqLines.length === 1 && reqLines[0] === 'Sin requisitos especificados');

    const loc   = cleanValue(vacancy.location);
    const phone = cleanValue(vacancy.contact_phone);
    const date  = cleanValue(vacancy.publication_date);
    const days  = cleanValue(vacancy.work_days);
    const sched = cleanValue(vacancy.schedule);

    // FIX: dividir ubicación en calle/número y colonia
    const { street, colony } = splitLocation(loc);

    // Construye el bloque de ubicación con 2 líneas si hay colonia
    const locHtml = loc ? `
        <span class="card-meta-item">
            <i class="fas fa-map-marker-alt"></i>
            <span>
                ${street ? `<span class="card-meta-loc-street">${escapeHtml(street)}</span>` : ''}
                ${colony ? `<span class="card-meta-loc-colony">${escapeHtml(colony)}</span>` : ''}
            </span>
        </span>` : '';

    return `
    <div class="vacancy-card" style="position:relative;">
        <button class="btn-download-card" onclick="downloadCard(this,'${vacancy.id}')" title="Descargar como imagen" data-html2canvas-ignore>
            <i class="fas fa-download"></i>
        </button>
        ${vacancy.category ? `<span class="card-category-badge"><i class="fas fa-tag"></i>${escapeHtml(vacancy.category)}</span>` : ''}
        <div class="card-img-wrap">
            ${vacancy.image_base64
                ? `<img src="${vacancy.image_base64}" alt="${escapeHtml(vacancy.company)}" loading="lazy">`
                : '<div class="card-img-placeholder"><i class="fas fa-image"></i></div>'}
        </div>
        <div class="card-content">
            <h3 class="card-company">${escapeHtml(cleanValue(vacancy.company))}</h3>
            <div class="card-title-meta-row">
                <p class="job-title text-purple-600"><span class="job-title-prefix">Vacante(s):</span> ${escapeHtml(cleanValue(vacancy.job_title))}</p>
                <div class="card-meta-inline">
                    ${locHtml}
                    ${phone ? `<span class="card-meta-item"><i class="fas fa-phone"></i><span>${escapeHtml(phone)}</span></span>` : ''}
                    ${date  ? `<span class="card-meta-item"><i class="fas fa-calendar"></i><span>${escapeHtml(date)}</span></span>` : ''}
                </div>
            </div>
            ${hasDesc ? `<p class="card-description mb-3">${escapeHtml(desc)}</p>` : ''}
            ${hasReqs ? `
                <div class="requirements-block mb-4">
                    <p class="req-block-title"><i class="fas fa-clipboard-list mr-1"></i>Requisitos</p>
                    <ul class="requirements-list">${reqLines.map(r => `<li>${escapeHtml(r)}</li>`).join('')}</ul>
                </div>
            ` : ''}
            ${(days || sched) ? `
                <div class="card-info-rows mb-4">
                    ${days  ? `<div class="card-info-row"><i class="fas fa-clock"></i><span>${escapeHtml(days)}</span></div>` : ''}
                    ${sched ? `<div class="card-info-row"><i class="fas fa-business-time"></i><span>${escapeHtml(sched)}</span></div>` : ''}
                </div>
            ` : ''}
            ${isOwner ? `
                <div class="flex gap-2 mt-auto" data-html2canvas-ignore>
                    <button data-edit="${vacancy.id}" class="btn btn-edit flex-1"><i class="fas fa-edit"></i> Editar</button>
                    <button data-delete="${vacancy.id}" class="btn btn-cancel flex-1"><i class="fas fa-trash"></i> Eliminar</button>
                </div>
            ` : `
                ${phone ? (() => {
                    const rawPhone = phone.replace(/[\s\-\(\)\.]/g, '');
                    const phoneNum = rawPhone.startsWith('+') ? rawPhone : `+52${rawPhone}`;
                    const msg = encodeURIComponent('Hola, que tal 👋 vi el anuncio de una vacante, de la cual estoy interesado(a) a través de la página *ECOSISTEMA LEÓN*, ¿podría brindarme más detalles por favor?');
                    return `<a href="https://wa.me/${phoneNum}?text=${msg}" target="_blank" rel="noopener noreferrer" class="btn-whatsapp-card" data-html2canvas-ignore><i class="fab fa-whatsapp"></i> Contactar WhatsApp</a>`;
                })() : ''}
            `}
        </div>
    </div>`;
}

function renderForm() {
    return `
    <div class="min-h-screen py-8">
        <div class="max-w-3xl mx-auto px-4">
            <div class="bg-white rounded-3xl shadow-2xl overflow-hidden fade-in">
                <div class="form-header-purple">
                    <button type="button" id="form-back-btn" class="back-btn-inheader" title="Volver"><i class="fas fa-arrow-left"></i></button>
                    <div class="form-header-content">
                        <h2 class="text-3xl font-black mb-2">${state.editingVacancy ? 'Editar' : 'Nueva'} Vacante</h2>
                        <p class="text-purple-200">Completa la información</p>
                    </div>
                </div>
                <form id="vacancy-form" class="p-8 space-y-6">
                    <div class="input-group">
                        <label>Imagen</label>
                        <div class="image-upload-area has-image" id="image-upload-area">
                            <div class="image-preview-container">
                                <img src="${state.formData.imageBase64 || 'https://raw.githubusercontent.com/Compualextech24/empleosdeleongtoaxel/main/SINFOTO.jpg'}" alt="Vista previa">
                            </div>
                        </div>
                        <p id="img-upload-hint" style="text-align:center;margin-top:8px;font-size:13px;font-weight:600;color:#1d4ed8;cursor:pointer;text-decoration:underline;letter-spacing:0.01em;">
                            <i class="fas fa-camera" style="margin-right:4px;"></i>Haz click aquí para actualizar la imagen
                        </p>
                        <input type="file" accept="image/*" id="img" style="display:none">
                    </div>
                    <div class="input-group">
                        <label>Empresa <span style="color:#ef4444">*</span></label>
                        <input type="text" id="company" placeholder="EJ: CALZADO LEÓN" value="${escapeHtml(state.formData.company)}" style="text-transform:uppercase;" autocomplete="off">
                    </div>
                    <div class="input-group">
                        <label>Puesto</label>
                        <input type="text" id="job_title" placeholder="Ej: Desarrollador" value="${escapeHtml(state.formData.job_title)}">
                    </div>
                    <div class="input-group">
                        <label>Descripción breve <span style="color:#ef4444">*</span></label>
                        <textarea id="description" rows="3" maxlength="300" placeholder="Ej: Se solicita personal para limpieza y acabado de costura...">${escapeHtml(state.formData.description)}</textarea>
                    </div>
                    <div class="input-group">
                        <label>Requisitos <span class="req-hint">— uno por línea, Enter para agregar más</span></label>
                        <div class="requirements-textarea-wrap">
                            <textarea id="requirements" rows="5" maxlength="500" class="requirements-input"
                                placeholder="Disponibilidad y actitud de trabajar&#10;Acta de nacimiento&#10;INE&#10;CURP&#10;Carta de no antecedentes penales">${escapeHtml(state.formData.requirements)}</textarea>
                            <div class="req-lines-preview" id="req-preview" aria-hidden="true">
                                ${state.formData.requirements
                                    ? state.formData.requirements.split('\n').map(l => l.trim()).filter(l => l.length > 0).map(l => `<span class="req-pill">${escapeHtml(l)}</span>`).join('')
                                    : '<span class="req-empty-hint">Los requisitos aparecerán aquí</span>'}
                            </div>
                        </div>
                    </div>
                    <div class="input-group">
                        <label>Ubicación</label>
                        <input type="text" id="location" placeholder="Calle Principal 123, Col. Centro, León GTO" value="${escapeHtml(state.formData.location || 'León, gto')}">
                    </div>
                    <div class="input-group">
                        <label>Categoría <span style="color:#ef4444">*</span></label>
                        <select id="category">
                            <option value="">-- Selecciona una categoría --</option>
                            <option value="Fábricas y Calzado"        ${state.formData.category === 'Fábricas y Calzado'        ? 'selected' : ''}>🏭 Fábricas y Calzado</option>
                            <option value="Tiendas y Ventas"          ${state.formData.category === 'Tiendas y Ventas'          ? 'selected' : ''}>🛒 Tiendas y Ventas</option>
                            <option value="Hospitales y Salud"        ${state.formData.category === 'Hospitales y Salud'        ? 'selected' : ''}>🏥 Hospitales y Salud</option>
                            <option value="Hoteles y Restaurantes"    ${state.formData.category === 'Hoteles y Restaurantes'    ? 'selected' : ''}>🍽️ Hoteles y Restaurantes</option>
                            <option value="Bodegas y Transporte"      ${state.formData.category === 'Bodegas y Transporte'      ? 'selected' : ''}>🚚 Bodegas y Transporte</option>
                            <option value="Oficinas y Administración" ${state.formData.category === 'Oficinas y Administración' ? 'selected' : ''}>🏢 Oficinas y Administración</option>
                            <option value="Obra y Construcción"       ${state.formData.category === 'Obra y Construcción'       ? 'selected' : ''}>🏗️ Obra y Construcción</option>
                            <option value="Escuelas y Clases"         ${state.formData.category === 'Escuelas y Clases'         ? 'selected' : ''}>📚 Escuelas y Clases</option>
                            <option value="Sistemas y Computación"    ${state.formData.category === 'Sistemas y Computación'    ? 'selected' : ''}>💻 Sistemas y Computación</option>
                            <option value="Leyes y Consultas"         ${state.formData.category === 'Leyes y Consultas'         ? 'selected' : ''}>⚖️ Leyes y Consultas</option>
                            <option value="Bancos y Contabilidad"     ${state.formData.category === 'Bancos y Contabilidad'     ? 'selected' : ''}>🏦 Bancos y Contabilidad</option>
                            <option value="Mantenimiento y Limpieza"  ${state.formData.category === 'Mantenimiento y Limpieza'  ? 'selected' : ''}>🧹 Mantenimiento y Limpieza</option>
                            <option value="Otros"                     ${state.formData.category === 'Otros'                     ? 'selected' : ''}>🔹 Otros</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="input-group">
                            <label>Teléfono</label>
                            <input type="text" id="contact_phone" placeholder="477-123-4567" value="${escapeHtml(state.formData.contact_phone)}">
                        </div>
                        <div class="input-group">
                            <label>Fecha publicación <span style="color:#ef4444">*</span></label>
                            <input type="text" id="publication_date" placeholder="DD/MM/AAAA" maxlength="10"
                                value="${escapeHtml(state.formData.publication_date)}" style="letter-spacing:0.05em;" autocomplete="off">
                            <small style="color:#6b7280;font-size:11px;margin-top:4px;display:block;">Formato: DD/MM/AAAA · Ej: 25/07/2025</small>
                        </div>
                    </div>
                    <div class="input-group">
                        <label>Días de trabajo</label>
                        <textarea id="work_days" rows="2" maxlength="100" placeholder="Lunes a Viernes">${escapeHtml(state.formData.work_days)}</textarea>
                    </div>
                    <div class="input-group">
                        <label>Horario</label>
                        <textarea id="schedule" rows="2" maxlength="100" placeholder="09:00 - 18:00">${escapeHtml(state.formData.schedule)}</textarea>
                    </div>
                    <div class="form-buttons-container">
                        <div class="form-main-buttons">
                            <button type="button" id="cancel-btn" class="btn-compact btn-cancel"><i class="fas fa-times"></i> Cancelar</button>
                            <button type="button" id="clean-btn" class="btn-compact btn-clean"><i class="fas fa-eraser"></i> Limpiar</button>
                            <button type="submit" class="btn-compact btn-save" ${state.loading ? 'disabled' : ''}>
                                ${state.loading ? '<i class="fas fa-spinner fa-spin"></i> Guardando...' : (state.editingVacancy ? '<i class="fas fa-edit"></i> Actualizar' : '<i class="fas fa-save"></i> Publicar')}
                            </button>
                        </div>
                        <button type="button" id="ai-btn" class="btn-compact btn-autofill form-ai-button">
                            <i class="fas fa-robot"></i> IA — Autofill (Solo Administradores)
                        </button>
                    </div>
                </form>
            </div>
        </div>
        ${state.aiChatOpen ? renderAIChat() : ''}
    </div>`;
}

function renderAIChat() {
    return `
    <div class="ai-chat-modal ${state.chatMinimized ? 'minimized' : ''}">
        <div class="ai-chat-header" id="ai-header">
            <h3><i class="fas fa-robot mr-2"></i>Autofill IA</h3>
            <div class="flex items-center gap-2">
                <button class="close-btn" id="minimize-ai"><i class="fas fa-minus"></i></button>
                <button class="close-btn" id="close-ai"><i class="fas fa-times"></i></button>
            </div>
        </div>
        <div class="ai-chat-messages">
            ${state.aiMessages.map(m => `<div class="ai-message ${m.role}">${escapeHtml(m.content)}</div>`).join('')}
            ${state.aiLoading ? '<div class="ai-message bot"><span class="ai-loading"></span> Procesando...</div>' : ''}
        </div>
        <div class="ai-chat-input">
            <div class="file-upload">
                <label><i class="fas fa-paperclip mr-1"></i> Imagen<input type="file" accept="image/*" id="ai-img"></label>
                ${state.aiImagePreview ? `
                    <div class="file-preview">
                        <img src="${state.aiImagePreview}" alt="Preview">
                        <button id="remove-ai-img" class="remove-file">×</button>
                    </div>
                ` : ''}
            </div>
            <textarea id="ai-chat-input" placeholder="Describe la vacante..." rows="3"></textarea>
            <div class="ai-chat-actions">
                <button id="send-ai" class="btn-send" ${state.aiLoading ? 'disabled' : ''}><i class="fas fa-paper-plane"></i> Enviar</button>
                <button id="start-ai" class="btn-start" ${!state.aiExtractedData || state.aiLoading ? 'disabled' : ''}><i class="fas fa-play"></i> START</button>
                <button id="close-ai-2" class="btn-close-chat"><i class="fas fa-times"></i> Cerrar</button>
            </div>
        </div>
    </div>`;
}

// ==================== EVENTOS ====================
function attachEvents() {
    // Login
    const loginForm = document.getElementById('login-form');
    if (loginForm) {
        loginForm.onsubmit = handleLogin;
        document.getElementById('email').oninput     = (e) => state.formData.email    = e.target.value;
        document.getElementById('password').oninput  = (e) => state.formData.password = e.target.value;
        document.getElementById('toggle-pwd')?.addEventListener('click', () => {
            const inp  = document.getElementById('password');
            const icon = document.querySelector('#toggle-pwd i');
            if (!inp) return;
            state.showPassword = !state.showPassword;
            inp.type = state.showPassword ? 'text' : 'password';
            if (icon) icon.className = `fas ${state.showPassword ? 'fa-eye-slash' : 'fa-eye'}`;
        });
        document.getElementById('go-signup')?.addEventListener('click', () => { state.view = 'signup'; resetAuthForm(); render(); });
        document.getElementById('forgot-password-btn')?.addEventListener('click', handleForgotPassword);
        document.getElementById('guest-btn')?.addEventListener('click', handleGuestAccess);
    }

    // Signup
    const signupForm = document.getElementById('signup-form');
    if (signupForm) {
        signupForm.onsubmit = handleSignup;
        document.getElementById('email').oninput            = (e) => state.formData.email           = e.target.value;
        document.getElementById('password').oninput         = (e) => state.formData.password        = e.target.value;
        document.getElementById('confirm-password').oninput = (e) => state.formData.confirmPassword = e.target.value;
        document.getElementById('toggle-pwd')?.addEventListener('click', () => {
            const inp = document.getElementById('password');
            const icon = document.querySelector('#toggle-pwd i');
            if (!inp) return;
            state.showPassword = !state.showPassword;
            inp.type = state.showPassword ? 'text' : 'password';
            if (icon) icon.className = `fas ${state.showPassword ? 'fa-eye-slash' : 'fa-eye'}`;
        });
        document.getElementById('toggle-confirm-pwd')?.addEventListener('click', () => {
            const inp = document.getElementById('confirm-password');
            const icon = document.querySelector('#toggle-confirm-pwd i');
            if (!inp) return;
            state.showConfirmPassword = !state.showConfirmPassword;
            inp.type = state.showConfirmPassword ? 'text' : 'password';
            if (icon) icon.className = `fas ${state.showConfirmPassword ? 'fa-eye-slash' : 'fa-eye'}`;
        });
        document.getElementById('go-login')?.addEventListener('click', () => { state.view = 'login'; render(); });
        document.getElementById('signup-back-btn')?.addEventListener('click', () => { state.view = 'login'; resetAuthForm(); render(); });
        document.getElementById('signup-cancel-btn')?.addEventListener('click', () => { state.view = 'login'; resetAuthForm(); render(); });
    }

    // Terms
    document.getElementById('accept-terms')?.addEventListener('change', (e) => {
        state.acceptedTerms = e.target.checked;
        const btn = document.getElementById('accept-btn');
        if (btn) btn.disabled = !state.acceptedTerms;
    });
    document.getElementById('accept-btn')?.addEventListener('click', handleAcceptTerms);

    // Dashboard / categories comunes
    document.getElementById('new-vacancy')?.addEventListener('click', () => { state.view = 'form'; resetJobForm(); clearAIData(); render(); });
    document.getElementById('calendar-btn')?.addEventListener('click', openCalendar);
    document.getElementById('user-menu')?.addEventListener('click', () => { state.menuOpen = !state.menuOpen; render(); });
    document.getElementById('logout')?.addEventListener('click', handleLogout);
    document.getElementById('delete-account')?.addEventListener('click', handleDeleteAccount);
    document.getElementById('go-login')?.addEventListener('click', () => { state.view = 'login'; render(); });
    document.getElementById('go-signup-from-empty')?.addEventListener('click', () => { state.view = 'signup'; render(); });
    document.getElementById('back-categories')?.addEventListener('click', () => { state.view = 'categories'; state.dateFilter = null; render(); });

    // Categorías
    document.querySelectorAll('[data-category], [data-is-all]').forEach(btn => {
        btn.addEventListener('click', () => {
            const isAll = btn.dataset.isAll === 'true';
            state.selectedCategory = isAll ? null : btn.dataset.category;
            state.dateFilter = null;
            state.view = 'dashboard';
            render();
        });
    });

    document.getElementById('quick-terms-btn')?.addEventListener('click', () => { state.view = 'terms'; render(); });
    document.getElementById('quick-vacancy-btn')?.addEventListener('click', () => {
        if (state.user) { state.view = 'form'; resetJobForm(); clearAIData(); render(); }
        else { showModal('question', 'Necesitas una cuenta', 'Para publicar vacantes debes iniciar sesión o crear una cuenta gratuita. ¿Deseas registrarte ahora?', () => { state.view = 'signup'; render(); }); }
    });

    // Cards
    document.querySelectorAll('[data-edit]').forEach(btn   => btn.addEventListener('click', () => handleEditVacancy(btn.dataset.edit)));
    document.querySelectorAll('[data-delete]').forEach(btn => btn.addEventListener('click', () => handleDeleteVacancy(btn.dataset.delete)));

    // Form
    const vacancyForm = document.getElementById('vacancy-form');
    if (vacancyForm) {
        vacancyForm.onsubmit = handleSaveVacancy;

        const imageArea = document.querySelector('.image-upload-area');
        const imgInput  = document.getElementById('img');
        const imgHint   = document.getElementById('img-upload-hint');
        if (imageArea && imgInput) { imageArea.addEventListener('click', () => imgInput.click()); imgInput.addEventListener('change', handleImageUpload); }
        if (imgHint  && imgInput)  { imgHint.addEventListener('click', () => imgInput.click()); }

        if (!state.formData.location) state.formData.location = 'León, gto';

        document.getElementById('company').oninput = (e) => { const u = e.target.value.toUpperCase(); e.target.value = u; state.formData.company = u; };
        document.getElementById('job_title').oninput    = (e) => state.formData.job_title    = e.target.value;
        document.getElementById('description').oninput  = (e) => state.formData.description  = e.target.value;
        document.getElementById('location').oninput     = (e) => state.formData.location     = e.target.value;
        document.getElementById('category').onchange    = (e) => state.formData.category     = e.target.value;
        document.getElementById('contact_phone').oninput = (e) => state.formData.contact_phone = e.target.value;
        document.getElementById('work_days').oninput    = (e) => state.formData.work_days    = e.target.value;
        document.getElementById('schedule').oninput     = (e) => state.formData.schedule     = e.target.value;

        document.getElementById('requirements').oninput = (e) => {
            state.formData.requirements = e.target.value;
            const preview = document.getElementById('req-preview');
            if (preview) {
                const lines = e.target.value.split('\n').map(l => l.trim()).filter(l => l.length > 0);
                preview.innerHTML = lines.length > 0
                    ? lines.map(l => `<span class="req-pill">${escapeHtml(l)}</span>`).join('')
                    : '<span class="req-empty-hint">Los requisitos aparecerán aquí</span>';
            }
        };

        // Auto-formato fecha DD/MM/AAAA
        const dateInput = document.getElementById('publication_date');
        if (dateInput) {
            dateInput.addEventListener('input', (e) => {
                let v = e.target.value.replace(/\D/g, '');
                if (v.length > 8) v = v.slice(0, 8);
                if (v.length >= 5)      v = v.slice(0,2) + '/' + v.slice(2,4) + '/' + v.slice(4);
                else if (v.length >= 3) v = v.slice(0,2) + '/' + v.slice(2);
                e.target.value = v;
                state.formData.publication_date = v;
            });
            dateInput.addEventListener('keydown', (e) => {
                if (e.key === 'Backspace') {
                    const val = dateInput.value;
                    if (val.endsWith('/')) { e.preventDefault(); dateInput.value = val.slice(0, -1); state.formData.publication_date = dateInput.value; }
                }
            });
        }

        document.getElementById('cancel-btn')?.addEventListener('click', cancelForm);
        document.getElementById('form-back-btn')?.addEventListener('click', () => { state.view = 'categories'; state.editingVacancy = null; resetJobForm(); clearAIData(); render(); });
        document.getElementById('clean-btn')?.addEventListener('click', cleanForm);
        document.getElementById('ai-btn')?.addEventListener('click', toggleAIChat);
    }

    // AI Chat
    document.getElementById('ai-chat-input')?.addEventListener('keypress', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendAIMessage(); } });
    document.getElementById('send-ai')?.addEventListener('click', sendAIMessage);
    document.getElementById('start-ai')?.addEventListener('click', startAutofill);
    document.getElementById('close-ai')?.addEventListener('click',   () => { state.aiChatOpen = false; clearAIData(); render(); });
    document.getElementById('close-ai-2')?.addEventListener('click', () => { state.aiChatOpen = false; clearAIData(); render(); });
    document.getElementById('minimize-ai')?.addEventListener('click', () => { state.chatMinimized = !state.chatMinimized; render(); });
    document.getElementById('ai-img')?.addEventListener('change', handleAIImageUpload);
    document.getElementById('remove-ai-img')?.addEventListener('click', removeAIImage);
}

// ==================== INICIALIZACIÓN ====================
async function init() {
    console.log('🚀 Inicializando Empleos León GTO...');
    try {
        const { data } = await supabaseClient.auth.getSession();
        if (data?.session?.user) {
            state.user = data.session.user;
            const accepted = localStorage.getItem('terms_accepted_' + data.session.user.id);
            state.acceptedTerms = !!accepted;
            state.view = accepted ? 'categories' : 'terms';
            await loadVacancies();
        }

        supabaseClient.auth.onAuthStateChange(async (event, session) => {
            console.log('🔐 Auth event:', event);

            if (event === 'PASSWORD_RECOVERY') {
                console.log('🔑 PASSWORD_RECOVERY - mostrando modal');
                showNewPasswordModal();
                return;
            }

            if (event !== 'INITIAL_SESSION') {
                hideLoading();
                state.isRendering = false;
            }

            if (state.isLoggingOut && event === 'SIGNED_OUT') {
                console.log('✅ Logout completado');
                state.isLoggingOut = false;
                return;
            }
            if (event === 'SIGNED_OUT' && !state.user) {
                console.log('⏭️ SIGNED_OUT ignorado');
                return;
            }

            if ((event === 'SIGNED_IN' || event === 'EMAIL_CONFIRMED' || event === 'USER_UPDATED') && session?.user) {
                state.user = session.user;
                state.isGuest = false;
                const accepted = localStorage.getItem('terms_accepted_' + session.user.id);
                state.acceptedTerms = !!accepted;
                state.view = accepted ? 'categories' : 'terms';
                await loadVacancies();
                hideLoading();
                render(true);
                if (event === 'EMAIL_CONFIRMED') {
                    showModal('success', '✅ Correo confirmado', '¡Tu cuenta fue verificada! Has iniciado sesión correctamente.');
                } else if (event === 'SIGNED_IN') {
                    showModal('success', '¡Bienvenido!', 'Has iniciado sesión correctamente');
                }
            } else if (event === 'SIGNED_OUT' && state.user && !state.isLoggingOut) {
                console.log('🔄 SIGNED_OUT inesperado - reseteando estado');
                resetCompleteState();
                render(true);
            }
        });

        supabaseClient
            .channel(ENDPOINTS.CHANNELS.VACANCIES)
            .on('postgres_changes', { event: '*', schema: 'public', table: ENDPOINTS.TABLES.VACANCIES }, async () => {
                await loadVacancies();
                if (state.view === 'dashboard' || state.view === 'categories') render();
            })
            .subscribe();

        render(true);
        console.log('✅ App lista');
    } catch (error) {
        console.error('❌ Error init:', error);
        render(true);
    }
}

if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
} else {
    init();
}
    </script>
</body>
</html>
